<!DOCTYPE html>
<html lang="id" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Kolektor PBB</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- CryptoJS for hashing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- SheetJS Library for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsPDF core -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>

        :root {
            --primary: #00c9ff;
            --secondary: #6e47f3;
            --success: #00d478;
            --warning: #ffd700;
            --danger: #ff3366;
            --info: #44b0f4;
            --light-bg: #f8f9fa;
            --text-dark: #1a1a2e;
            --text-muted: #6c757d;
            --card-bg: #ffffff;
            --border-color: #e9ecef;
            --gradient-primary: linear-gradient(135deg, var(--primary), var(--secondary));
            --gradient-success: linear-gradient(135deg, var(--success), var(--info));
        }
        [data-bs-theme="dark"] {
            --light-bg: #121212;
            --card-bg: #1e1e1e;
            --text-dark: #f8f9fa;
            --text-muted: #adb5bd;
            --border-color: #2d2d2d;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            padding-top: 0;
            transition: all 0.5s ease;
        }
        /* === DASHBOARD HEADER IMPROVED === */
        .dashboard-header {
            margin-top: 0;
            margin-bottom: 5px;
            background: var(--gradient-primary);
            border-radius: 0 0 20px 20px;
            padding: 30px 30px 25px 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            text-align: center;
            position: relative;
            overflow: hidden;
            border: none;
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            position: relative;
            z-index: 1;
        }
        .dashboard-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
        }
        .dashboard-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.5) 0%, 
                rgba(255,255,255,0.8) 50%, 
                rgba(255,255,255,0.5) 100%);
            border-radius: 0 0 20px 20px;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .dashboard-header h1 {
            font-weight: 800;
            font-size: 2.5rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 0.8rem;
            letter-spacing: 0.5px;
            position: relative;
            display: inline-block;
        }
        .dashboard-header h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 2px;
        }
        .dashboard-header p {
            font-size: 1.2rem;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto 0;
            font-weight: 300;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .header-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            width: 70px;
            line-height: 70px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        /* === STICKY HEADER & FOOTER (Tanpa Ubah Tampilan) === */
        .sticky-header-wrapper {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: transparent; /* Tetap transparan, tidak ubah desain */
        }

        .sticky-footer-wrapper {
            position: sticky;
            bottom: 0;
            z-index: 1500;
            background: transparent; /* Tetap transparan, tidak ubah desain */
        }
        /* === MAIN CONTENT ADJUSTMENT === */
        .main-content {
            min-height: calc(100vh - 200px); /* Sesuaikan tinggi minimal agar footer tidak menempel terlalu tinggi */
            padding: 15px 10px;
        }
        /* === COLLECTOR CARDS === */
        .collector-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            height: 100%;
            border: 1px solid var(--border-color);
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }
        .collector-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.5s ease;
        }
        .collector-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .collector-card:hover::before {
            transform: scaleX(1);
        }
        .collector-card.active {
            border-color: var(--primary);
            box-shadow: 0 8px 20px rgba(0, 201, 255, 0.2);
            z-index: 10;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .collector-name {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--text-dark);
            margin: 0;
            transition: color 0.3s ease;
        }
        .collector-card:hover .collector-name {
            color: var(--primary);
        }
        .collector-target {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .progress-container {
            margin: 15px 0;
        }
        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }
        .progress-value {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.75rem;
        }
        .progress-bar {
            transition: width 1.5s ease-in-out;
            border-radius: 10px;
            height: 10px;
        }
        .progress-percentage {
            font-weight: 700;
            font-size: 1.1rem;
            text-align: center;
            margin-top: 8px;
        }
        .chart-container {
            position: relative;
            height: 100px;
            margin-top: 10px;
            margin-bottom: 5px;
            border-radius: 10px;
            background-color: var(--card-bg);
            padding: 10px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .performance-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid transparent;
        }
        .performance-excellent {
            background-color: rgba(0, 212, 120, 0.2);
            color: var(--success);
            border-color: rgba(0, 212, 120, 0.3);
            box-shadow: 0 0 6px rgba(0, 212, 120, 0.3);
        }
        .performance-good {
            background-color: rgba(68, 176, 244, 0.2);
            color: var(--info);
            border-color: rgba(68, 176, 244, 0.3);
            box-shadow: 0 0 6px rgba(68, 176, 244, 0.3);
        }
        .performance-average {
            background-color: rgba(255, 215, 0, 0.2);
            color: var(--warning);
            border-color: rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 6px rgba(255, 215, 0, 0.3);
        }
        .performance-poor {
            background-color: rgba(255, 51, 102, 0.2);
            color: var(--danger);
            border-color: rgba(255, 51, 102, 0.3);
            box-shadow: 0 0 6px rgba(255, 51, 102, 0.3);
        }
        /* === STAT CARDS === */
        .stat-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            text-align: center;
            height: 100%;
            border: 1px solid var(--border-color);
            transition: cardAppear 5s ease forwards;
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.5s ease;
        }
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }
        .stat-card h5 {
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        .stat-card h2 {
            font-weight: 800;
            font-size: 1.8rem;
            color: var(--primary);
            margin: 0;
            transition: color 0.3s ease;
        }
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
            opacity: 0.8;
        }
        /* === ANIMASI DASHBOARD STATISTIK === */

        /* Efek muncul bertahap untuk card statistik */
        .stat-card {
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUpStats 0.8s ease forwards;
            animation-delay: calc(0.1s * var(--index, 0)); /* Delay berbeda untuk tiap card */
        }

        /* Keyframe animasi muncul dari bawah */
        @keyframes fadeInUpStats {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Efek glow halus saat hover */
        .stat-card:hover {
            box-shadow: 0 12px 30px rgba(0, 201, 255, 0.2), 0 4px 6px rgba(0, 0, 0, 0.05);
            transform: translateY(-8px) scale(1.03) !important;
            border-color: rgba(0, 201, 255, 0.4);
        }

        /* Animasi count-up untuk angka statistik */
        .stat-card h2 {
            font-weight: 800;
            font-size: 1.8rem;
            color: var(--primary);
            margin: 0;
            transition: color 0.3s ease;
            /* Animasi count-up */
            animation: countUp 3s ease-out forwards;
            counter-reset: num var(--target, 0);
        }

        /* Keyframe animasi count-up */
        @keyframes countUp {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Tambahkan efek shimmer pada icon */
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
            opacity: 0.8;
            position: relative;
            display: inline-block;
            animation: floatIcon 3s ease-in-out infinite;
        }

        /* Animasi melayang lembut untuk icon */
        @keyframes floatIcon {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
            }
            50% {
                transform: translateY(-6px) rotate(3deg);
            }
        }

        /* Efek gradient shimmer pada card saat hover */
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            z-index: 1;
            transition: left 0.8s ease-out;
            pointer-events: none;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        /* === RESPONSIVE ADJUSTMENTS === */
        @media (max-width: 768px) {
            .stat-card h2 {
                font-size: 1.5rem;
                animation: countUp 1.5s ease-out forwards; /* Lebih cepat di mobile */
            }
            .stat-icon {
                font-size: 2rem;
                animation: floatIcon 2s ease-in-out infinite; /* Lebih cepat di mobile */
            }
        }

        @media (max-width: 576px) {
            .stat-card h2 {
                font-size: 1.4rem;
            }
            .stat-icon {
                font-size: 1.8rem;
            }
        }
        /* === GRID CARD STYLES === */
        .grid-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .grid-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 1s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transform: translateY(20px);
            opacity: 0;
            animation: cardAppear 5s ease forwards;
        }
        @keyframes cardAppear {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .grid-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        .grid-card:hover::before {
            transform: scaleX(1);
        }
        .grid-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        .grid-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .grid-card-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-dark);
            margin: 0;
            line-height: 1.4;
        }
        .grid-card-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            flex-shrink: 0;
            margin-left: 10px;
        }
        .grid-card-content {
            margin-bottom: 15px;
        }
        .grid-card-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--border-color);
        }
        .grid-card-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .grid-card-label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        .grid-card-value {
            font-weight: 600;
            color: var(--text-dark);
            text-align: right;
            font-size: 0.8rem;
        }
        .grid-card-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
        }
        .status-lunas {
            background-color: rgba(0, 212, 120, 0.15);
            color: var(--success);
        }
        .status-belum {
            background-color: rgba(255, 51, 102, 0.15);
            color: var(--danger);
        }
        /* === PERBAIKAN LOADING INDICATOR === */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(5px);
        }

        [data-bs-theme="dark"] .loading-overlay {
            background-color: rgba(18, 18, 18, 0.9);
        }

        .loading-content {
            text-align: center;
            padding: 2rem;
            border-radius: 16px;
            background: var(--card-bg);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            max-width: 90%;
            width: 300px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 1.5rem;
            position: relative;
        }

        .loading-spinner-inner {
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            position: relative;
        }

        .loading-spinner-inner::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            border: 3px solid transparent;
            border-top: 3px solid var(--secondary);
            border-radius: 50%;
            animation: spinReverse 1.5s linear infinite;
        }

        .loading-text {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .loading-subtext {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .loading-progress {
            width: 100%;
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            margin-top: 1rem;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            width: 0%;
            background: var(--gradient-primary);
            border-radius: 3px;
            transition: width 0.4s ease;
            animation: progressPulse 2s infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes spinReverse {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(-360deg); }
        }

        @keyframes progressPulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading-hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Responsive adjustments */
        @media (max-width: 576px) {
            .loading-content {
                padding: 1.5rem;
                width: 260px;
            }
            
            .loading-spinner {
                width: 50px;
                height: 50px;
                margin-bottom: 1rem;
            }
            
            .loading-text {
                font-size: 1rem;
            }
            
            .loading-subtext {
                font-size: 0.85rem;
            }
        }
        /* === SIDEBAR STYLES === */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            z-index: 1800;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            padding-top: 70px;
            display: flex;
            flex-direction: column;
        }

        .sidebar.show {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            background: var(--card-bg);
            z-index: 1001;
        }

        .sidebar-logo {
            font-weight: 800;
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0;
        }

        .sidebar-nav {
            padding: 10px 0;
            flex-grow: 1;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            color: var(--text-dark);
            text-decoration: none;
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .nav-link:hover,
        .nav-link.active {
            background: var(--gradient-primary);
            color: white;
        }

        .nav-link i {
            margin-right: 12px;
            font-size: 1.2rem;
        }

        .nav-link.logout {
            color: var(--danger);
        }

        .nav-link.logout:hover {
            background: rgba(255, 51, 102, 0.1);
            color: var(--danger);
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: white;
            font-weight: bold;
        }

        .user-details {
            flex-grow: 1;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .user-role {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1050;
            cursor: pointer;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Adjust main content when sidebar is visible */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* PERBAIKAN: Konten utama dan footer */
        .main-content-wrapper {
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            transition: margin-left 0.3s ease;
        }

        .app-footer {
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 20px 0;
            text-align: center;
            color: var(--text-muted);
            transition: margin-left 0.3s ease;
        }

        /* Adjust content when sidebar is visible */
        body.sidebar-visible .main-content-wrapper,
        body.sidebar-visible .app-footer {
            margin-left: 250px;
            width: calc(100% - 250px);
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .sidebar {
                width: 250px;
            }
            
            .sidebar-header {
                width: 250px;
            }
            
            body.sidebar-visible .main-content-wrapper,
            body.sidebar-visible .app-footer {
                margin-left: 0;
                width: 100%;
            }
            
            .sidebar-overlay.show {
                opacity: 1;
                visibility: visible;
            }
        }
        /* Tombol Unduh Excel */
        .btn-download-excel {
            background: #00d478;
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 100px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-download-excel:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 212, 120, 0.3);
        }
        /* Tombol Cetak PDF */
        .btn-print-pdf {
            background: linear-gradient(135deg, #00c9ff, #6e47f3);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 80px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-print-pdf:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 201, 255, 0.3);
        }

                /* Tombol Sync */
        .btn-sync-global{
            background: linear-gradient(135deg, #cbe78a, #eeb703);
            border: none;
            color: white;
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 80px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-sync-global:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 201, 255, 0.3);
        }
        /* === RESPONSIVE UNTUK MOBILE === */
        @media (max-width: 768px) {
            .sink-report-filter {
                max-width: 100%;
                font-size: 0.7rem;
            }
            .btn-print {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
            .sink-report-table th,
            .sink-report-table td {
                font-size: 0.65rem;
                padding: 3px 2px;
            }
            .sink-status {
                font-size: 0.6rem;
                padding: 2px 5px;
            }
            .table-info {
                font-size: 0.7rem;
            }
            .pagination .page-link {
                font-size: 0.65rem;
                padding: 0.15rem 0.3rem;
            }
        }
/* === RESPONSIVE TABLE FOR MOBILE === */
@media (max-width: 768px) {
    .sink-report-table {
        font-size: 0.6rem;
        overflow-x: auto;
    }
    .sink-report-table th,
    .sink-report-table td {
        padding: 4px 3px;
        white-space: nowrap;
    }
}
        /* === PERKECIL UKURAN FONT UNTUK TABEL LAPORAN SINK === */
        /* Filter dan tombol */
        .btn-print {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }

        /* Header tabel */
        .sink-report-table th {
            font-size: 0.8rem;
            padding: 5px 4px;
        }

        /* Konten tabel */
        .sink-report-table td {
            font-size: 0.8rem;
            padding: 4px 3px;
        }

        /* Status badge */
        .sink-status {
            font-size: 0.7rem;
            padding: 3px 6px;
        }

        /* Informasi pagination */
        .table-info {
            font-size: 0.7rem;
        }

        /* Pagination */
        .pagination .page-link {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }

        /* === TABEL LAPORAN SINK === */
        .sink-report-container {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 8px;
            margin-bottom: 7px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

.sink-report-container:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

        .sink-report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .sink-report-title {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--text-dark);
            margin: 0;
        }

        .sink-report-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sink-report-filter {
            max-width: 160px;
        }

.table-container {
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    /* Memastikan tabel tetap di tengah */
    margin:auto;
    width: 100%;
    max-width: 100%;
}
.table-container > table {
    display: inline-block; /* Biarkan tabel "mengambang" sesuai isi */
    min-width: 100%; /* Tetap responsif di layar kecil */
}

/* === MEMUSATKAN TABEL DI TENGAH HALAMAN === */
.sink-report-container {
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    /* Memusatkan tabel di tengah halaman */
    margin-left: auto;
    margin-right: auto;
    max-width: 95%; /* Maksimal lebar 95% dari layar */
    width: 100%;
}
.sink-report-container > .table-container {
    width: fit-content; /* Hanya selebar isi tabel */
    max-width: 100%; /* Tapi tidak melebihi lebar layar */
    overflow-x: auto;
    padding: 0;
}
.sink-report-table {
    background: var(--card-bg);
    border-spacing: 0;
}
.sink-report-table th,
.sink-report-table td {
    text-align: center;
    vertical-align: middle;
}

.sink-report-table {
    width: 100%;
    margin-bottom: 0;
    border-collapse: collapse;
    table-layout: auto; /* Biarkan lebar kolom menyesuaikan isi */
    margin: 0 auto; /* Memusatkan tabel */
}

@media (max-width: 768px) {
    .sink-report-container {
        margin-left: auto;
        margin-right: auto;
        max-width: 98%;
        padding: 5px;
    }
    .sink-report-table {
        font-size: 0.75rem;
    }
    .sink-report-table th,
    .sink-report-table td {
        padding: 4px 3px;
    }
}

        .sink-report-table th {
            background-color: rgba(0, 201, 255, 0.1);
            color: var(--text-dark);
            font-weight: 600;
            padding: 7px 7px;
            text-align: left;
            border-bottom: 2px solid var(--border-color);
        }

        .sink-report-table td {
            padding: 5px 5px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .sink-report-table tbody tr:hover {
            background-color: rgba(0, 201, 255, 0.05);
        }

        .sink-status {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }

        .sink-synced {
            background-color: rgba(0, 212, 120, 0.15);
            color: var(--success);
        }

        .sink-pending {
            background-color: rgba(255, 215, 0, 0.15);
            color: var(--warning);
        }

        .sink-failed {
            background-color: rgba(255, 51, 102, 0.15);
            color: var(--danger);
        }

        .table-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .table-info {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .sink-report-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .sink-report-filters {
                margin-top: 15px;
                width: 100%;
                justify-content: space-between;
            }

            .sink-report-filter {
                max-width: 48%;
            }
        }

        @media (max-width: 768px) {
            .sink-report-container {
                padding: 15px;
            }

            .sink-report-filters {
                flex-direction: column;
                gap: 10px;
            }

            .sink-report-filter {
                max-width: 100%;
            }
        }

        @media (max-width: 576px) {
            .table-pagination {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .pagination {
                margin-bottom: 0;
            }
        }
        
        /* PERBAIKAN UTAMA: Layout kartu kolektor */
        #collectorCardsContainer {
            display: flex;
            flex-wrap: wrap;
            margin-right: -15px;
            margin-left: -15px;
        }
        
        #collectorCardsContainer > .col-xl-3 {
            flex: 0 0 25%;
            max-width: 25%;
            padding-right: 15px;
            padding-left: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1200px) {
            #collectorCardsContainer > .col-xl-3 {
                flex: 0 0 33.333333%;
                max-width: 33.333333%;
            }
        }
        
        @media (max-width: 992px) {
            #collectorCardsContainer > .col-xl-3 {
                flex: 0 0 50%;
                max-width: 50%;
            }
        }
        
        @media (max-width: 768px) {
            #collectorCardsContainer > .col-xl-3 {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }
        
        .performance-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid transparent;
        }
        
        .performance-excellent {
            background-color: rgba(0, 212, 120, 0.2);
            color: var(--success);
            border-color: rgba(0, 212, 120, 0.3);
        }
    
        
        .progpercentageress- {
            font-weight: 700;
            font-size: 1.1rem;
            text-align: center;
            margin-top: 8px;
        }
        /* === MEMPERKECIL UKURAN TEKS INFO PAGINATION === */
        #tableInfo {
            font-size: 0.7rem; /* Ukuran font lebih kecil */
            font-weight: 500;
            color: var(--text-muted);
        }
        #sinkTableInfo {
            font-size: 0.7rem; /* Ukuran font lebih kecil */
            font-weight: 500;
            color: var(--text-muted);
        }
        /* Toast notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .custom-toast {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        /* === MODAL DETAIL STYLES === */
        .badge.status-lunas {
            background-color: rgba(0, 212, 120, 0.15);
            color: #00d478;
            border: 1px solid rgba(0, 212, 120, 0.3);
        }
        .badge.status-belum {
            background-color: rgba(255, 51, 102, 0.15);
            color: #ff3366;
            border: 1px solid rgba(255, 51, 102, 0.3);
        }
        .bg-gradient-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            min-height: 100vh;
        }
        /* Modal Detail Styles */
        .modal-detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-detail-label {
            font-weight: 600;
            color: var(--text-muted);
        }
        .modal-detail-value {
            font-weight: 600;
            color: var(--text-dark);
            text-align: right;
        }
        .btn-bayar {
            background: var(--gradient-success);
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .btn-bayar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 120, 0.3);
        }

/* === TOMBOLOL RELOAD (REFRESH) - DIPERBAIKI === */

.refresh-btn {
    position: fixed;
    top: 20px;
    right: 50px;
    z-index: 1050;
    cursor: pointer;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--card-bg);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    border: none; /* Hapus border default */
    transition: all 0.3s ease;
    animation: pulse 2s infinite;
    opacity: 0.9;
}

.refresh-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0, 201, 255, 0.3);
    opacity: 1;
}

.refresh-btn:active {
    transform: scale(0.95);
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(0, 201, 255, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(0, 201, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 201, 255, 0); }
}

/* Ikon refresh dengan warna biru cerah */
.refresh-btn i {
    color: var(--primary);
    font-size: 1rem;
    transition: transform 0.3s ease;
}

.refresh-btn:hover i {
    transform: rotate(90deg);
}
        /* === FLOATING THEME SWITCHER === */
        .floating-theme-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            cursor: pointer;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: var(--card-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .floating-theme-switcher:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        /* === FOOTER === */
        .app-footer {
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 20px 0;
            margin-top: 30px;
            text-align: center;
            color: var(--text-muted);
        }
        /* === ANIMATIONS === */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15) !important;
        }
/* === PERBAIKAN PAGINATION === */
.pagination {
    display: flex;
    justify-content: center; /* Menyusun tombol di tengah */
    align-items: center;       /* Menyelaraskan secara vertikal */
    gap: 5px;                  /* Jarak antar tombol */
    margin: 10px 0;            /* Margin atas-bawah */
}

.pagination .page-link {
    padding: 5px 6px;         /* Padding lebih besar */
    font-size: 0.6rem;       /* Ukuran font sedang */
    border-radius: 4px;        /* Sudut bulat halus */
    transition: all 0.3s ease;
}

.pagination .page-link:hover,
.pagination .page-link.active {
    background-color: #00c9ff; /* Warna biru sesuai tema */
    color: white;
    border-color: #00c9ff;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.pagination .page-link.active {
    z-index: 2;
}

.pagination .page-link.disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

  /* === RESPONSIF FONT UNTUK MOBILE (GLOBAL) === */
@media (max-width: 768px) {
    /* Ukuran font utama */
    body {
        font-size: 0.8rem;
    }
    /* Judul besar */
    h1 {
        font-size: 1.5rem !important;
    }
    /* Judul sedang */
    h2, .dashboard-header h1 {
        font-size: 1.3rem !important;
    }
    /* Judul kecil */
    h3, .collector-name, .grid-card-title {
        font-size: 1rem !important;
    }
    h4 {
        font-size: 1rem !important;
    }
    h5, .stat-card h5 {
        font-size: 0.9rem !important;
    }
    h6 {
        font-size: 0.85rem !important;
    }
    /* Teks biasa dan label */
    p, label, .text-muted, .grid-card-label, .modal-detail-label {
        font-size: 0.8rem !important;
    }
    /* Nilai dan teks penting */
    .stat-card h2, .progress-percentage, .grid-card-value, .modal-detail-value {
        font-size: 0.8rem !important;
    }
    /* Badge dan status */
    .performance-badge, .grid-card-badge, .sink-status {
        font-size: 0.7rem !important;
        padding: 0.25rem 0.5rem !important;
    }
    /* Input dan tombol */
    .form-control, .form-select, .btn {
        font-size: 0.7rem !important;
        padding: 0.25rem 0.5rem !important;
    }
    .btn-sm {
        font-size: 0.7rem !important;
        padding: 0.2rem 0.4rem !important;
    }
    /* Tabel
    .print-table th, .print-table td,
    .sink-report-table th, .sink-report-table td {
        font-size: 0.7rem !important;
        padding: 0.25rem !important;
    } */
    /* Progress label dan value */
    .progress-label, .progress-value {
        font-size: 0.75rem !important;
    }
    /* Toast notification */
    .toast-body, .toast-header {
        font-size: 0.8rem !important;
    }
    /* Modal title */
    .modal-title {
        font-size: 1.1rem !important;
    }
    /* Footer */
    .app-footer p {
        font-size: 0.8rem !important;
    }
}
@media (max-width: 480px) {
    body {
        font-size: 0.8rem;
    }
    h1 { font-size: 1.3rem !important; }
    h2 { font-size: 1.1rem !important; }
    h3 { font-size: 1rem !important; }
    p, label { font-size: 0.8rem !important; }
    .btn, .form-control { font-size: 0.8rem !important; padding: 0.2rem 0.4rem !important; }
}   

/* === REKAP RW & RT === */
#rekapRWRTSection .sink-report-table th {
    font-size: 1rem;
    padding: 6px 5px;
    text-align: center;
    font-weight: bold;
}
#rekapRWRTSection .sink-report-table td {
    font-size: 0.8rem;
    padding: 6px 5px;
}
#rekapRWRTSection .rw-row {
    background-color: rgba(0, 201, 255, 0.1);
    font-weight: bold;
}
#rekapRWRTSection .rt-row {
    background-color: rgba(0, 201, 255, 0.05);
}
/* === BARIS TOTAL UNTUK TABEL REKAP === */
.total-row {
    background: linear-gradient(135deg, #00c9ff, #6e47f3) !important;
    color: black !important;
    font-weight: bold;
    border-top: 2px solid var(--border-color);
}
.total-row td {
    padding: 8px 5px !important;
    vertical-align: middle;
}
.total-row td:first-child {
    text-align: center;
    font-size: 0.9rem;
}

/* Tambahkan style untuk form */
#addUserForm .form-label {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 0.3rem;
}

#addUserForm .form-control,
#addUserForm .form-select {
  font-size: 0.9rem;
  padding: 0.5rem 0.75rem;
}

#addUserForm .form-text {
  font-size: 0.8rem;
  color: #6c757d;
}

#userTable th {
  font-size: 0.8rem;
  font-weight: 600;
  background-color: rgba(3, 188, 240, 0.719);
}

#userTable td {
  font-size: 0.85rem;
  vertical-align: middle;
}

.btn-sm {
  padding: 0.2rem 0.4rem;
  font-size: 0.75rem;
} 

/* Style untuk dropdown role */
.role-select {
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
    width: 100px;
    cursor: pointer;
}

.role-select:focus {
    border-color: #00c9ff;
    box-shadow: 0 0 0 0.2rem rgba(0, 201, 255, 0.25);
}

/* Badge alternatif untuk role (jika tidak menggunakan dropdown) */
.role-badge {
    cursor: pointer;
    transition: all 0.3s ease;
}

.role-badge:hover {
    opacity: 0.8;
    transform: scale(1.05);
}

/* Style untuk inline reset password */
.reset-password-container {
    display: inline-block;
    margin-right: 5px;
}

.reset-form {
    display: flex;
    gap: 3px;
    align-items: center;
}

.reset-input {
    font-size: 0.75rem;
    height: 28px;
    padding: 0.25rem 0.5rem;
}

.btn-start-reset,
.btn-confirm-reset,
.btn-cancel-reset {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.btn-confirm-reset {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
}

.btn-confirm-reset:hover {
    background: linear-gradient(135deg, #218838, #1e9e8a);
    transform: scale(1.05);
}

.btn-cancel-reset {
    background: linear-gradient(135deg, #6c757d, #5a6268);
    border: none;
}

.btn-cancel-reset:hover {
    background: linear-gradient(135deg, #5a6268, #4e555b);
    transform: scale(1.05);
}

/* Animasi untuk form reset */
.reset-form {
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Responsive design */
@media (max-width: 768px) {
    .reset-form {
        flex-direction: column;
        gap: 2px;
    }
    
    .reset-input {
        width: 80px !important;
    }
}

.sink-report-table thead th {
    text-align: center;
    vertical-align: middle;
    font-weight: bold;
    background-color: #f5f7fa; /* abu muda */
    padding: 8px;
} 

@media (max-width: 768px) {
  .sink-report-table,
  .sink-report-table thead,
  .sink-report-table tbody,
  .sink-report-table th,
  .sink-report-table td,
  .sink-report-table tr {
    display: block;
    width: 100%;
  }

  /* Sembunyikan header tabel */
  .sink-report-table thead {
    display: none;
  }

  /* Setiap baris jadi kartu */
  .sink-report-table tr {
    margin-bottom: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--card-bg);
    padding: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  /* Setiap sel jadi baris grid */
  .sink-report-table td {
    display: flex;
    justify-content: space-between;
    text-align: left;
    padding: 6px 8px;
    border: none;
    font-size: 0.85rem;
  }

  /* Tambahkan label otomatis dari atribut data-label */
  .sink-report-table td::before {
    content: attr(data-label);
    font-weight: 600;
    color: var(--text-muted);
  }
}

@media (max-width: 768px) {
  .sink-report-table td {
    display: flex;
    justify-content: space-between;
    padding: 6px 8px;
  }

  .sink-report-table td::before {
    content: attr(data-label);
    color: #555;
  }
}


/* Sembunyikan tombol cetak PDF di layar kecil */
@media screen and (max-width: 768px) {
  .btn-print-pdf {
    display: none !important;
  }
}

/* CSS untuk wizard */
.wizard-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 9998;
}

.sync-wizard {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  max-width: 500px;
  background: white;
  border-radius: 15px;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
  z-index: 9999;
  opacity: 0;
  transition: all 0.3s ease;
}

.wizard-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 15px 15px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.close-wizard {
  font-size: 2rem;
  cursor: pointer;
  padding: 0 10px;
}

.step-indicator {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 20px 0;
}

.step {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: #e9ecef;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.step.active {
  background: #007bff;
  color: white;
}

.step-line {
  width: 40px;
  height: 2px;
  background: #e9ecef;
}

.wizard-content {
  padding: 25px;
}

.wizard-step {
  display: none;
}

.wizard-step.active {
  display: block;
  animation: fadeIn 0.5s;
}

.data-summary {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  margin: 10px 0;
  padding: 10px 0;
  border-bottom: 1px solid #eee;
}

.warning-box {
  background: #fff3cd;
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid #ffc107;
  font-size: 0.9rem;
}

.existing-download-section {
  text-align: center;
  margin: 20px 0;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 10px;
}

.download-status {
  margin-top: 15px;
  font-size: 0.9rem;
  color: #6c757d;
  text-align: center;
}

.final-summary {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  margin: 20px 0;
}

.warning-final {
  background: #f8d7da;
  color: #721c24;
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid #dc3545;
  font-weight: 500;
}

.wizard-footer {
  display: flex;
  justify-content: space-between;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 0 0 15px 15px;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Perbaiki CSS step indicator */
.step-indicator {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 20px 0;
}

.step {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: #e9ecef;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  transition: all 0.3s ease;
}

.step.active {
  background: #007bff;
  color: white;
  transform: scale(1.1);
}

.step-line {
  width: 40px;
  height: 2px;
  background: #e9ecef;
}

/* Tambahkan di CSS Anda */
.btn .spinner {
    animation: spin 1s linear infinite;
}

/* === GIRIK TAGIHAN SECTION === */
#girikSection .sink-report-container {
    padding: 20px;
    margin-bottom: 0;
}

.girik-header {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e9ecef;
    background: #f8f9fa;
    border-radius: 12px;
}

.girik-logo {
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 102, 204, 0.1);
    border-radius: 50%;
    border: 1px solid #0066cc;
}

.girik-title {
    flex-grow: 1;
}

.girik-main-title {
    margin: 0;
    font-size: 2rem;
    font-weight: 800;
    color: #0066cc;
    line-height: 1.2;
}

.girik-subtitle {
    margin: 5px 0 0 0;
    font-size: 1rem;
    font-weight: 700;
    color: #0066cc;
    letter-spacing: 0.5px;
}

.girik-search-container {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 10px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
    font-size: 1rem;
}

#btnRefreshGirik {
    border: none;
    background: transparent;
    padding: 0;
    color: #6c757d;
    transition: color 0.3s ease;
}
#btnRefreshGirik:hover {
    color: #007bff;
}

#girikSuggestions {
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-top: none;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}

.girik-suggestion-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f8f9fa;
    transition: background-color 0.2s ease;
}

.girik-suggestion-item:hover,
.girik-suggestion-item.active {
    background-color: #f8f9fa;
}

.girik-suggestion-item strong {
    display: block;
    color: #0066cc;
}

.girik-suggestion-item small {
    color: #6c757d;
    display: block;
    font-size: 0.85rem;
}

.btn-print-girik-pdf {
    min-width: 160px;
}

/* Responsive */
@media (max-width: 768px) {
    .girik-header {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    .girik-logo {
        margin-bottom: 10px;
    }
    .girik-main-title {
        font-size: 1.8rem;
    }
    .girik-subtitle {
        font-size: 0.8rem;
    }
    .girik-search-container {
        padding: 5px;
    }
}

#printArea .print-summary {
    font-size: 0pt;
}

.print-subtitle {
    font-size: 0pt;
}

.print-info {
    font-size: 0pt;
} 

.print-footer {
    font-size: 0pt;
}

.print-title {
    font-size: 0pt;
}


.print-table {
    font-size: 0pt;
}

/* === PRINT GIRIK TAGIHAN === */
@media print {
    body * { visibility: hidden; }
    #printGirikArea, #printGirikArea * { visibility: visible; }
    #printGirikArea { position: absolute; left: 0; top: 0; }
    #printArea, #printArea * {visibility: visible;}
    #printArea { position: absolute; top: 0; left: 0;}
    #printRWRTArea, #printRWRTArea * { visibility: visible; }
    #printRWRTArea { position: absolute; top: 0; left: 0; }
    #printAreaKolektor, #printAreaKolektor * { visibility: visible; }
    #printAreaKolektor { position: absolute; left: 0; top: 0; }
}

/* ==================== GLOBAL PRINT STYLES ==================== */
@media print {
    /* RESET & BASE STYLES */
    * {
        box-sizing: border-box;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    body {
        font-family: "Arial", "Helvetica", sans-serif;
        font-size: 10pt;
        line-height: 1.3;
        color: #000;
        background: #fff;
        margin: 0;
        padding: 0;
        width: 100%;
        visibility: hidden;
    }
    
   .print-area, .print-area * {
       visibility: visible;
  }

    /* HEADERS */
    h1, h2, h3, h4, h5, h6 {
        font-family: "Arial", "Helvetica", sans-serif;
        color: #000;
        margin: 0.5em 0;
        page-break-after: avoid;
    }
    
    h1 { font-size: 16pt; font-weight: bold; }
    h2 { font-size: 14pt; font-weight: bold; }
    h3 { font-size: 12pt; font-weight: bold; }
    
    /* PARAGRAPHS & TEXT */
    p {
        margin: 0.3em 0;
        font-size: 10pt;
    }
    
    strong {
        font-weight: bold;
    }
    
    /* TABLE CONTAINERS */
    .print-container {
        width: 100%;
        margin: 0 auto;
        padding: 0;
    }
    
    .print-page {
        width: 100%;
        height: auto;
        padding: 10mm;
        margin: 0 auto;
        box-sizing: border-box;
        page-break-inside: avoid;
    }
    
    .print-header {
        text-align: center;
        margin-bottom: 5mm;
        padding-bottom: 3mm;
        border-bottom: 1.5pt solid #000;
        page-break-after: avoid;
    }
    
    .print-title {
        font-size: 16pt;
        font-weight: bold;
        color: #000;
        margin-bottom: 2mm;
    }
    
    .print-subtitle {
        font-size: 12pt;
        color: #000;
        font-weight: bold;
    }
    
    .print-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4mm;
        font-size: 9pt;
        border-bottom: 1pt solid #ccc;
        padding-bottom: 2mm;
    }
    
    .print-footer {
        text-align: center;
        font-size: 8pt;
        color: #000;
        border-top: 1pt solid #000;
        padding-top: 2mm;
        margin-top: 5mm;
        page-break-before: avoid;
    }
    
    /* ==================== TABLE STYLES ==================== */
    .print-table {
        width: 100%;
        border-collapse: collapse;
        border-spacing: 0;
        font-size: 9pt;
        table-layout: auto;
        margin: 0 auto;
        page-break-inside: auto;
        align-items: center;
    }
    
    .print-table-container {
    width: 100%;
    display: flex;
    justify-content: center; /* Memusatkan horizontal */
    }

    .print-table th,
    .print-table td {
        padding: 3pt 4pt;
        text-align: left;
        vertical-align: top;
        border: 1pt solid #000;
        word-wrap: break-word;
        overflow-wrap: break-word;
        page-break-inside: avoid;
    }
    
    .print-table th {
        background-color: #f0f0f0;
        font-weight: bold;
        text-align: center;
        color: #000;
    }
    
    /* Column alignment helpers */
    .print-table .text-left { text-align: left; }
    .print-table .text-center { text-align: center; }
    .print-table .text-right { text-align: right; }
    
    /* Zebra striping for better readability */
    .print-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    
    /* Row styles */
    .print-table .summary-row {
        font-weight: bold;
        background-color: #e0e0e0;
    }
    
    .print-table .total-row {
        font-weight: bold;
        background-color: #d0d0d0;
    }
    
    /* ==================== RESPONSIVE TABLE PRINT ==================== */
    /* Prevent page breaks inside rows */
    .print-table tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }
    
    /* Ensure tables don't break across pages if possible */
    .print-table {
        page-break-inside: auto;
    }
    
    /* Force landscape for wide tables */
    @page landscape {
        size: landscape;
        margin: 10mm;
    }
    
    .landscape-table {
        page: landscape;
    }
    
    /* ==================== UTILITY CLASSES ==================== */
    .page-break-before {
        page-break-before: always;
    }
    
    .page-break-after {
        page-break-after: always;
    }
    
    .avoid-break-inside {
        page-break-inside: avoid;
    }
    
    .keep-with-next {
        page-break-after: avoid;
    }
    
    .keep-together {
        page-break-inside: avoid;
    }
    
    /* ==================== SPECIFIC TABLE COLUMN WIDTHS ==================== */
    /* Auto-width columns that adjust to content */
    .print-table .col-auto {
        width: auto;
        min-width: 20mm;
    }
    
    /* Fixed width columns */
    .print-table .col-10 { width: 10mm; }
    .print-table .col-15 { width: 15mm; }
    .print-table .col-20 { width: 20mm; }
    .print-table .col-25 { width: 25mm; }
    .print-table .col-30 { width: 30mm; }
    .print-table .col-35 { width: 35mm; }
    .print-table .col-40 { width: 40mm; }
    .print-table .col-45 { width: 45mm; }
    .print-table .col-50 { width: 50mm; }
    
    /* Percentage width columns */
    .print-table .col-5p { width: 5%; }
    .print-table .col-10p { width: 10%; }
    .print-table .col-15p { width: 15%; }
    .print-table .col-20p { width: 20%; }
    .print-table .col-25p { width: 25%; }
    .print-table .col-30p { width: 30%; }
    .print-table .col-35p { width: 35%; }
    .print-table .col-40p { width: 40%; }
    .print-table .col-45p { width: 45%; }
    .print-table .col-50p { width: 50%; }
    
    /* ==================== CONDENSED MODE FOR LARGE TABLES ==================== */
    .print-table.condensed {
        font-size: 8pt;
    }
    
    .print-table.condensed th,
    .print-table.condensed td {
        padding: 2pt 3pt;
    }
    
    /* ==================== NO PRINT ELEMENTS ==================== */
    .no-print {
        display: none !important;
    }
    
    /* ==================== BORDER CONTROL ==================== */
    .print-table.borderless th,
    .print-table.borderless td {
        border: none;
    }
    
    .print-table.borderless th {
        border-bottom: 1pt solid #000;
    }
    
    /* ==================== PAGE SETUP ==================== */
    @page {
        size: auto;
        margin: 20mm;
        marks: crop;
    }
    
    @page :first {
        margin-top: 15mm;
    }
    
    /* ==================== FOOTNOTES ==================== */
    .footnotes {
        font-size: 8pt;
        margin-top: 5mm;
        border-top: var(--gradient-primary)
        padding-top: 2mm;
    }
    
    /* ==================== WATERMARK ==================== */
    .watermark {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 60pt;
        color: rgba(0, 0, 0, 0.1);
        z-index: -1;
        pointer-events: none;
    }

}

/* ==================== SCREEN PREVIEW STYLES ==================== */
@media screen {
    .print-preview {
        width: 210mm;
        min-height: 297mm;
        padding: 10mm;
        margin: 20px auto;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        background: white;
        font-family: "Arial", "Helvetica", sans-serif;
        font-size: 10pt;
    }
    
    .print-preview .print-table {
        font-size: 9pt;
    }
}

/* ==================== DARK MODE PRINT ADJUSTMENT ==================== */
@media print and (prefers-color-scheme: dark) {
    body {
        color: #000;
        background: #fff;
    }
    
    .print-table th {
        background-color: #f0f0f0 !important;
        color: #000 !important;
    }
    
    .print-table tr:nth-child(even) {
        background-color: #f9f9f9 !important;
    }
    
    .print-table .summary-row {
        background-color: #e0e0e0 !important;
    }
    
    .print-table .total-row {
        background-color: #d0d0d0 !important;
    }
}
  </style>
</head>
<body>
    <!-- LOGIN CONTAINER -->
    <div id="loginContainer" class="d-flex align-items-center justify-content-center min-vh-100 bg-gradient-primary">
        <div class="card shadow-lg" style="width: 100%; max-width: 400px; border-radius: 20px;">
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <i class="bi bi-person-badge-fill" style="font-size: 3rem; color: var(--primary);"></i>
                    <h3 class="mt-3 fw-bold">Login Dashboard PBB</h3>
                    <p class="text-muted">Silakan masukkan username dan password Anda</p>
                </div>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label fw-semibold">Username</label>
                        <div class="input-group">TD
                            <span class="input-group-text"><i class="bi bi-person"></i></span>
                            <input type="text" class="form-control" id="username" name="username" placeholder="Masukkan username" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="password" class="form-label fw-semibold">Password</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                            <input type="password" class="form-control" id="password" name="password" placeholder="Masukkan password" required>
                        </div>
                    </div>
                    <div id="loginAlert" class="alert alert-danger d-none" role="alert">
                        Username atau password salah.
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2 rounded-pill fw-bold">
                        <i class="bi bi-box-arrow-in-right me-2"></i> Login
                    </button>
                </form>
            </div>
            <div class="card-footer text-center text-muted py-3">
                 2025 Desa Cilayung. All rights reserved.
            </div>
        </div>
    </div>

    <!-- DASHBOARD CONTAINER (Awalnya disembunyikan) -->
    <div id="dashboardContainer" class="d-none">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-logo">PBB Dashboard</h3>
            </div>
            <nav class="sidebar-nav">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-section="dashboard">
                            <i class="bi bi-speedometer2"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="bayar">
                            <i class="bi bi-credit-card"></i>
                            <span>Bayar</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="laporan">
                            <i class="bi bi-file-bar-graph"></i>
                            <span>Laporan</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="girik">
                            <i class="bi bi-file-earmark-text"></i>
                            <span>Girik Tagihan</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="rekap-rw-rt">
                            <i class="bi bi-house-fill"></i>
                            <span>Rekap RW & RT</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="rekap-kolektor">
                            <i class="bi bi-person-badge-fill"></i>
                            <span>Rekap Per Kolektor</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#userModal">
                            <i class="bi bi-people"></i> Manajemen Petugas
                        </a>
                    </li>
                    <li class="nav-item mt-4">
                        <a href="#" class="nav-link logout" id="sidebarLogout">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">
                        A
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Admin</div>
                        <div class="user-role" id="userRole">Administrator</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SIDEBAR OVERLAY -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- SIDEBAR TOGGLE BUTTON -->
        <div class="sidebar-toggle" id="sidebarToggle">
            <i class="bi bi-list"></i>
        </div>

        <!-- Main Content -->
        <div class="container-fluid px-0">

        <!-- PERBAIKAN: Wrap konten utama dalam wrapper -->
        <div class="main-content-wrapper">
            <!-- Header -->
            <div class="sticky-header-wrapper">
                <div class="dashboard-header mb-4" data-aos="fade-down">
                    <div class="header-icon">
                        <i class="bi bi-bar-chart-fill"></i>
                    </div>
                    <h1 class="text-white">DASHBOARD PBB</h1>
                    <p class="text-white mb-0">Monitoring Target dan Realisasi Pemungutan PBB Desa Cilayung</p>
                </div>
            </div>
            <div class="container-fluid main-content">
                <!-- Dashboard Stats -->
                <div class="row mb-4" data-aos="fade-up" id="dashboardStats">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stat-card card-hover">
                            <div class="stat-icon">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <h5>Total WP</h5>
                            <h2 class="card-text" id="totalCollectors">0</h2>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stat-card card-hover">
                            <div class="stat-icon">
                                <i class="bi bi-bullseye"></i>
                            </div>
                            <h5>Total Target PBB</h5>
                            <h2 class="card-text" id="totalTarget">Rp 0</h2>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stat-card card-hover">
                            <div class="stat-icon">
                                <i class="bi bi-cash-coin"></i>
                            </div>
                            <h5>Total Realisasi</h5>
                            <h2 class="card-text" id="totalRealisasi">Rp 0</h2>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="stat-card card-hover">
                            <div class="stat-icon">
                                <i class="bi bi-graph-up-arrow"></i>
                            </div>
                            <h5>Rata-rata Pencapaian</h5>
                            <h2 class="card-text" id="averageAchievement">0%</h2>
                        </div>
                    </div>
                </div>
                <!-- Loading Overlay (Baru) -->
                <div class="loading-overlay loading-hidden" id="loadingOverlay">
                    <div class="loading-content">
                        <div class="loading-spinner">
                            <div class="loading-spinner-inner"></div>
                        </div>
                        <div class="loading-text" id="loadingText">Memuat data</div>
                        <div class="loading-subtext" id="loadingSubtext">Harap tunggu sebentar...</div>
                        <div class="loading-progress">
                            <div class="loading-progress-bar" id="loadingProgressBar"></div>
                        </div>
                    </div>
                </div>
                <!-- Collector Cards Container -->
                <div class="row" id="collectorCardsContainer">
                    <!-- Cards will be generated here by JavaScript -->
                </div>
                <!-- Grid Card Container -->
                <div class="row mb-4" data-aos="fade-up" id="gridCardSection">
                    <div class="col-12">
                        <div class="table-card card-hover">
                            <div class="table-card-header">
                                <h5 class="table-card-title"><i class="bi bi-table me-2"></i>Data Detail Wajib Pajak</h5>
                                <div class="input-group mb-3" style="max-width: 360px;">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" id="searchInput" class="form-control" placeholder="Cari wajib pajak...">
                                </div>
                            </div>
                            <div class="grid-card-container" id="gridCardContainer">
                                <!-- Data akan diisi oleh JavaScript -->
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="text-muted" id="tableInfo">Menampilkan 0 - 0 data</div>
                                <nav>
                                    <ul class="pagination mb-0" id="pagination">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" tabindex="-1">Previous</a>
                                        </li>
                                        <li class="page-item active">
                                            <a class="page-link" href="#">1</a>
                                        </li>
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabel Laporan Sink -->
                <div class="row mb-4" data-aos="fade-up" id="sinkReportSection">
                    <div class="col-12">
                        <div class="sink-report-container">
                            <div class="sink-report-header">
                                <h3 class="sink-report-title">    
                                    <i class="bi bi-table me-2"></i>Laporan Sinkronisasi Data
                                </h3>
                                <div class="sink-report-filters">
                                    <select class="form-select sink-report-filter" style="width: 160px; font-size: 0.8rem; padding: 0.25rem 0.5rem;" id="sinkStatusFilter">
                                        <option value="Menunggu">Menunggu</option>
                                        <option value="Sinkron">Sinkron</option>
                                        <option value="Belum Bayar">Belum Bayar</option>
                                        <option value="all">Semua Status</option>
                                    </select>
                                    <select class="form-select sink-report-filter" style="width: 160px; font-size: 0.8rem; padding: 0.25rem 0.5rem;" id="paymentDateFilter">
                                        <option value="all">Semua Tanggal</option>
                                        <option value="today">Hari Ini</option>
                                        <option value="week">Minggu Ini</option>
                                        <option value="month">Bulan Ini</option>
                                    </select>
                                    <select class="form-select sink-report-filter" style="width: 160px; font-size: 0.8rem; padding: 0.25rem 0.5rem;" id="collectorFilter">
                                        <option value="all">Semua Kolektor</option>
                                        <!-- Opsi akan diisi oleh JavaScript -->
                                    </select>
                                    <button class="btn-print-pdf" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" id="btnPrintPDF">
                                        <i class="bi bi-file-earmark-pdf"></i> Cetak PDF
                                    </button>
                                    <button class="btn-download-excel" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" id="btnExportExcel">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> Unduh Excel
                                    </button>
                                    <div id="syncButtonContainer" style="display: none;">
                                    <button id="syncAllDataBtn" class="btn btn-warning btn-sync-global" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" onclick="syncAllData()">
                                    <i class="bi bi-speedometer2"></i> Sinkron Semua Data
                                    </button>                                    </div>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="sink-report-table">
                                    <thead>
                                        <tr>
                                            <th>NOP</th>
                                            <th style="text-align: center;">Tahun</th>
                                            <th>Nama Wajib Pajak</th>
                                            <th>Alamat Wajib Pajak</th>
                                            <th>Alamat Objek Pajak</th>
                                            <th style="text-align: center;">Desa</th>
                                            <th style="text-align: right;">Jumlah PBB</th>
                                            <th style="text-align: right;">Luas Tanah</th>
                                            <th style="text-align: right;">Luas bangunan</th>
                                            <th style="text-align: center;">Tanggal Bayar</th>
                                            <th style="text-align: center;">Status Sink</th>
                                            <th>Kolektor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sinkReportTableBody">
                                        <!-- Data akan diisi oleh JavaScript -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="total-row">
                                            <td colspan="6" style="text-align: right; font-weight: bold;">TOTAL POKOK PBB:</td>
                                            <td id="totalPokokPBB" style="text-align: right; font-weight: bold;"></td>
                                            <td colspan="5"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <div class="table-pagination">
                                <div class="table-info" id="sinkTableInfo">Menampilkan 0 - 0 data</div>
                                <nav>
                                    <ul class="pagination mb-0" id="sinkPagination">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" tabindex="-1">Previous</a>
                                        </li>
                                        <li class="page-item active">
                                            <a class="page-link" href="#">1</a>
                                        </li>
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabel Rekap RW & RT -->
                <div class="row mb-4" data-aos="fade-up" id="rekapRWRTSection" style="display: none;">
                    <div class="col-12">
                        <div class="sink-report-container">
                            <div class="sink-report-header">
                                <h3 class="sink-report-title">
                                    <i class="bi bi-house-fill me-2"></i>Rekapitulasi Per RW & RT
                                </h3>
                                <div class="sink-report-filters">
                                    <button class="btn-print-pdf" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" 
                                            id="btnPrintRWRTPDF">
                                        <i class="bi bi-file-earmark-pdf"></i> Cetak PDF
                                    </button>
                                    <button class="btn-download-excel" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" id="btnExportExcelRWRT">
                                        <i class="bi bi-file-earmark-spreadsheet"></i> Unduh Excel
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="sink-report-table">
                                    <thead>
                                        <tr>
                                            <th style="text-align: center;">RW/RT</th>
                                            <th style="text-align: center;">JML. WP</th>
                                            <th style="text-align: center;">TAERGET</th>
                                            <th style="text-align: center;">REALISASI</th>
                                            <th style="text-align: center;">% REALISASI</th>
                                            <th style="text-align: center;">SISA</th>
                                            <th style="text-align: center;">% SISA</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rekapRWRTTableBody">
                                        <!-- Data akan diisi oleh JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="table-pagination">
                                <div class="table-info" id="rekapRWRTInfo">Menampilkan 0 data</div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Area untuk cetak (disembunyikan default) -->
                <div id="printArea" style="display: none;">
                 <div class="print-page">
                    
                    <!-- Header -->
                    <div class="print-header">
                    <div class="print-title">LAPORAN SINKRONISASI PEMBAYARAN PBB</div>
                    <div class="print-subtitle">DESA CILAYUNG KECAMATAN JATINANGOR</div>
                    </div>

                    <!-- Info -->
                    <div class="print-info">
                    <div class="print-date" id="printDate"></div>
                    <div class="print-filter" id="printFilter"></div>
                    </div>

                    <!-- Tabel -->
                    <div class="print-table-container">
                    <table class="print-table" id="printTable">
                        <thead>
                        <tr>
                            <th>NO</th>
                            <th>NOP</th>
                            <th>Tahun</th>
                            <th>Nama Wajib Pajak</th>
                            <th>Alamat Wajib Pajak</th>
                            <th>Alamat Objek Pajak</th>
                            <th>Desa</th>
                            <th>Jumlah PBB</th>
                            <th>Tanggal Bayar</th>
                            <th>Kolektor</th>
                        </tr>
                        </thead>
                        <tbody id="printTableBody">
                        <!-- Data akan diisi oleh JS -->
                        </tbody>
                    </table>
                    </div>

                    <!-- Ringkasan -->
                    <div class="print-summary">
                    <div>Total Data: <span id="printTotalData">0</span></div>
                    <div>Sinkron: <span id="printSynced">0</span></div>
                    <div>Menunggu: <span id="printPending">0</span></div>
                    <div>Belum Bayar: <span id="printNotPaid">0</span></div>
                    <div>Total Jumlah PBB: <span id="printTotalPBB">0</span></div>
                    </div>

                    <!-- Footer -->
                    <div class="print-footer">
                    Dicetak pada: <span id="printTimestamp"></span>
                    </div>

                </div>
                </div>

<!-- Tabel Rekap Per Kolektor -->
<div class="row mb-4" data-aos="fade-up" id="rekapKolektorSection" style="display: none;">
    <div class="col-12">
        <div class="sink-report-container">
            <div class="sink-report-header">
                <h3 class="sink-report-title">
                    <i class="bi bi-person-badge-fill me-2"></i>Rekapitulasi Per Kolektor
                </h3>
                <div class="sink-report-filters">
                    <button class="btn-print-pdf" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" id="cetakRekapKolektor">
                        <i class="bi bi-file-earmark-pdf"></i> Cetak PDF
                    </button>
                    <button class="btn-download-excel" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" id="btnExportExcelKolektor">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Unduh Excel
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table class="sink-report-table">
                        <thead>
                        <tr>
                            <th rowspan="3">NO</th>
                            <th rowspan="3">NAMA KOLEKTOR</th>
                            <th colspan="2" rowspan="2">TARGET</th>
                            <th colspan="6">REALISASI PBB</th>
                            <th colspan="3" rowspan="2">SISA</th>
                        </tr>
                        <tr>
                            <th colspan="3" id="rentang1Header">TGL </th>
                            <th colspan="3" id="rentang2Header">S.D TGL </th>
                        </tr>
                        <tr>
                            <th>SPPT</th>
                            <th>Rp.</th>
                            <th>SPPT</th>
                            <th>Rp.</th>
                            <th>%</th>
                            <th>SPPT</th>
                            <th>Rp.</th>
                            <th>%</th>
                            <th>SPPT</th>
                            <th>Rp.</th>
                            <th>%</th>
                        </tr>
                        </thead>
                    <tbody id="rekapKolektorTableBody">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="table-pagination">
                <div class="table-info" id="rekapKolektorInfo">Menampilkan 0 data</div>
            </div>
        </div>
    </div>
</div>

<!-- Area untuk cetak PDF Rekap Kolektor (disembunyikan default) -->
<div id="printAreaKolektor" style="display: none;">
    <div class="print-page">
        <!-- Header -->
        <div class="print-header">
            <div class="print-title">REKAPITULASI REALISASI PBB PER KOLEKTOR</div>
            <div class="print-subtitle">DESA CILAYUNG KECAMATAN JATINANGOR</div>
        </div>
        <!-- Info -->
        <div class="print-info">
            <div class="print-date" id="printDateKolektor"></div>
            <div class="print-filter" id="printFilterKolektor">Rekapitulasi Per Kolektor</div>
        </div>
        <!-- Tabel -->
        <div class="print-table-container">
            <table class="print-table" id="printTableKolektor">
                        <thead>
                        <tr>
                            <th rowspan="3">NO</th>
                            <th rowspan="3">NAMA KOLEKTOR</th>
                            <th colspan="2" rowspan="2">TARGET</th>
                            <th colspan="6">REALISASI PBB</th>
                            <th colspan="3" rowspan="2">SISA</th>
                        </tr>
                        <tr>
                            <th colspan="3" id="rentang1Header">TGL </th>
                            <th colspan="3" id="rentang2Header">S.D TGL </th>
                        </tr>
                        <tr>
                            <th>SPPT</th>
                            <th>Rp.</th>
                            <th>SPPT</th>
                            <th>Rp.</th>
                            <th>%</th>
                            <th>SPPT</th>
                            <th>Rp.</th>
                            <th>%</th>
                            <th>SPPT</th>
                            <th>Rp.</th>
                            <th>%</th>
                        </tr>
                        </thead>
                <tbody id="printTableBodyKolektor">
                    <!-- Data akan diisi oleh JS -->
                </tbody>
            </table>
        </div>
        <!-- Footer -->
        <div class="print-footer">
            Dicetak pada: <span id="printTimestampKolektor"></span>
        </div>
    </div>
</div> 

<!-- Halaman Girik Tagihan -->
<div class="row mb-4" data-aos="fade-up" id="girikSection" style="display: none;">
    <div class="col-12">
        <div class="sink-report-container text-center">
            <!-- Header dengan Logo Kop Desa -->
            <div class="girik-header text-center mb-4 pb-3 border-bottom">
                <div class="d-flex justify-content-center align-items-center flex-column">
                    <img src="https://e-officedesa.sumedangkab.go.id/data/logo/skpd/sumedang.png" 
                         alt="Logo Desa Cilayung" 
                         class="me-3 girik-logo" 
                         style="width: 80px; height: 80px; object-fit: contain; border: 1px solid #e9ecef; border-radius: 50%;">
                    <div class="text-center mt-2">
                        <h4 class="girik-main-title mb-0">GIRIK TAGIHAN PBB</h4>
                        <h5 class="girik-subtitle mb-0">DESA CILAYUNG KECAMATAN JATINANGOR</h5>
                    </div>
                </div>
            </div>

            <!-- Filter Pencarian Dinamis -->
            <div class="girik-search-container mb-1 p-1 bg-white rounded-4 shadow-sm mx-auto" style="max-width: 400px;">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control form-control-sm" 
                           id="girikSearchInput" 
                           placeholder="Ketik nama pemilik..." 
                           autocomplete="off"
                           aria-label="Cari nama pemilik">
                    <button class="btn btn-outline-secondary" type="button" id="btnRefreshGirik" title="Muat ulang daftar">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <!-- Hasil pencarian dinamis -->
                <div class="list-group position-relative w-100 mt-1 shadow-sm rounded-3 border" 
                     id="girikSuggestions"
                     style="display: none; max-height: 200px; overflow-y: auto; background: white; z-index: 1000;">
                    <!-- Hasil pencarian akan diisi oleh JavaScript -->
                </div>
                <small class="form-text text-muted mt-1 d-block text-center">Saran muncul saat mengetik.</small>
            </div>

            <!-- Informasi Ringkasan -->
            <div class="alert alert-info d-none" id="girikInfoAlert" role="alert">
                <i class="bi bi-info-circle me-2"></i> Ketik nama pemilik untuk melihat hasil pencarian.
            </div>

            <!-- Tabel Data Girik -->
            <div class="table-container d-flex justify-content-center">
                <table class="sink-report-table">
                    <thead>
                        <tr>
                            <th>NO</th>
                            <th>NOP</th>
                            <th>NAMA WAJIB PAJAK</th>
                            <th>ALAMAT WAJIB PAJAK</th>
                            <th>ALAMAT OBJEK PAJAK</th>
                            <th>POKOK PBB</th>
                            <th>TANGGAL BAYAR</th>
                            <th>KOLEKTOR</th>
                        </tr>
                    </thead>
                    <tbody id="girikTableBody">
                        <!-- Data akan diisi oleh JavaScript -->
                    </tbody>
                    <tfoot>
                        <tr class="total-row">
                            <td colspan="6" style="text-align: right; font-weight: bold;">TOTAL POKOK PBB:</td>
                            <td id="girikTotalPBB" style="text-align: right; font-weight: bold;"></td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- Tombol Cetak PDF (di bawah tabel) -->
            <div class="d-flex justify-content-center mt-3">
                <button class="btn-print-pdf" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;" id="btnPrintGirikPDF">
                    <i class="bi bi-file-earmark-pdf"></i> Cetak PDF
                </button>
            </div>
        </div>
    </div>
</div>

                <!-- Footer -->
                <footer class="app-footer mt-5">
                    <div class="container">
                        <p class="mb-0"> 2025 Dashboard PBB Desa Cilayung. All rights reserved.</p>
                    </div>
                </footer>
            </div>
        
        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
        <!-- Floating Theme Switcher -->
        <div class="floating-theme-switcher" id="themeSwitcher">
            <i class="bi bi-sun-fill"></i>
        </div>
        <!-- Action Buttons -->
        <button class="refresh-btn" id="refreshData" title="Refresh Data" data-aos="fade-up">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
        <!-- Modal Detail -->
        <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detailModalTitle">Detail Wajib Pajak</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-3">
                            <!-- NOP -->
                            <div class="row mb-2 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-upc-scan me-1"></i> NOP
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="fw-semibold" id="modalNOP">-</span>
                                </div>
                            </div>
                            <!-- Nama WP -->
                            <div class="row mb-2 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-person-badge me-1"></i> Nama WP
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="fw-semibold" id="modalNama">-</span>
                                </div>
                            </div>
                            <!-- Alamat WP -->
                            <div class="row mb-2 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-person-badge me-1"></i> Alamat WP
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="fw-semibold" id="modalAlamatWP">-</span>
                                </div>
                            <!-- Alamat Objek -->
                            </div>
                            <div class="row mb-2 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-person-badge me-1"></i> Alamat OP
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="fw-semibold" id="modalAlamatObjek">-</span>
                                </div>
                            </div>
                            <!-- Pokok PBB -->
                            <div class="row mb-2 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-currency-dollar me-1"></i> Pokok PBB
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="fw-bold text-success" id="modalPBB">-</span>
                                </div>
                            </div>
                            <!-- Luas Tanah -->
                            <div class="row mb-2 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-currency-dollar me-1"></i> Luas Tanah
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="fw-bold text-success" id="modalluastanah">-</span>
                                </div>
                            </div>
                            <!-- Luas Bangunan -->
                            <div class="row mb-2 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-currency-dollar me-1"></i> Luas Bangunan
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="fw-bold text-success" id="modalluasbangunan">-</span>
                                </div>
                            </div>
                            <!-- Status -->
                            <div class="row mb-2 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-check-circle me-1"></i> Status
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="badge rounded-pill px-2 py-1 fw-bold" id="modalStatusBadge">-</span>
                                </div>
                            </div>
                            <!-- Tanggal Bayar -->
                            <div class="row mb-2 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-calendar-date me-1"></i> Tanggal Bayar
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="fw-semibold text-success" id="modalTanggal">-</span>
                                </div>
                            </div>
                            <!-- Nama Pemilik -->
                            <div class="row mb-0 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-person-check me-1"></i> Nama Pemilik
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="fw-semibold text-success" id="modalPemilik">-</span>
                                </div>
                            </div>
                            <!-- Alamat Pemilik -->
                            <div class="row mb-0 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-person-check me-1"></i> Alamat Pemilik
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="fw-semibold text-success" id="modalAlamatPemilik">-</span>
                                </div>
                            </div>
                            <!-- Kolektor -->
                            <div class="row mb-0 align-items-center">
                                <div class="col-5">
                                    <span class="d-flex align-items-center text-muted">
                                        <i class="bi bi-person-check me-1"></i> Kolektor
                                    </span>
                                </div>
                                <div class="col-7">
                                    <span class="fw-semibold text-primary" id="modalKolektor">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="button" class="btn btn-bayar" id="btnBayar">Bayar Sekarang</button>
                    
        <button type="button" class="btn btn-primary" id="btnUpdateDetail">Update</button>
</div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="logoutConfirmModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header p-4 bg-success">
                        <h5 class="modal-title">Konfirmasi Logout</h5>
                    </div>
                    <div class="modal-body p-4">
                        <p>Apakah Anda yakin ingin logout?</p>
                    </div>
                    <div class="modal-footer p-4">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="button" class="btn btn-secondary" id="confirmLogoutBtn">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Manajemen Petugas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Tombol Tambah Petugas -->
        <div class="mb-3">
          <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-person-plus"></i> Tambah Petugas
          </button>
        </div>
        
        <!-- Tabel Petugas -->
        <div class="table-responsive">
          <table class="table table-bordered table-sm table-hover" id="userTable">
            <thead class="table-light">
              <tr>
                <th>Username</th>
                <th>Nama Lengkap</th>
                <th>Role</th>
                <th>Jabatan</th>
                <th>Desa</th>
                <th>Kecamatan</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <!-- Data akan diisi oleh JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Tambah Petugas - Pastikan id-nya sama -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tambah Petugas Baru</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addUserForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Username <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="username" required>
              <div class="form-text">Untuk login ke sistem</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="nama" required>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Password <span class="text-danger">*</span></label>
              <input type="password" class="form-control" name="password" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Role <span class="text-danger">*</span></label>
              <select class="form-select" name="role" required>
                <option value="">Pilih Role</option>
                <option value="admin">Admin</option>
                <option value="kolektor">Kolektor</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Jabatan</label>
              <select class="form-select" name="jabatan">
                <option value="">Pilih Jabatan</option>
                <option value="Kepala Desa">Kepala Desa</option>
                <option value="Sekretaris Desa">Sekretaris Desa</option>
                <option value="Bendahara">Bendahara</option>
                <option value="Kasi Pemerintahan">Kasi Pemerintahan</option>
                <option value="Kasi Kesejahteraan">Kasi Kesejahteraan</option>
                <option value="Kasi Pelayanan">Kasi Pelayanan</option>
                <option value="Staff">Staff</option>
                <option value="Kolektor PBB">Kolektor PBB</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Desa</label>
              <select class="form-select" name="desa">
                <option value="">Pilih Desa</option>
                <option value="Cilayung">Cilayung</option>
                <option value="Cileles">Cileles</option>
                <option value="Cikeruh">Cikeruh</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Kecamatan</label>
              <select class="form-select" name="kecamatan">
                <option value="">Pilih Kecamatan</option>
                <option value="Jatinangor">Jatinangor</option>
                <option value="Cimanggung">Cimanggung</option>
                <option value="Tanjungsari">Tanjungsari</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="submit" class="btn btn-primary" form="addUserForm">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- Area untuk cetak PDF (disembunyikan) -->
<div id="printRWRTArea" style="display: none;">
    <div class="print-page">
        <div class="print-header">
            <div class="print-title">REKAPITULASI PEMBAYARAN PBB PER RW & RT</div>
            <div class="print-subtitle">DESA CILAYUNG KECAMATAN JATINANGOR</div>
        </div>
        
        <div class="print-info">
            <div class="print-date" id="printRWRTDate"></div>
            <div class="print-period" id="printRWRTPeriod"></div>
        </div>
        
        <div class="print-table-container">
            <table class="print-table" id="printRWRTTable">
                <thead>
                    <tr>
                        <th>RW/RT</th>
                        <th>JML. WP</th>
                        <th>TARGET (Rp)</th>
                        <th>REALISASI (Rp)</th>
                        <th>% REALISASI</th>
                        <th>SISA TARGET (Rp)</th>
                        <th>% SISA</th>
                    </tr>
                </thead>
                <tbody id="printRWRTTableBody">
                    <!-- Data akan diisi oleh JavaScript -->
                </tbody>
                <tfoot id="printRWRTTableFooter">
                    <!-- Total akan diisi oleh JavaScript -->
                </tfoot>
            </table>
        </div>
        
        <div class="print-footer">
            <div>Dicetak pada: <span id="printRWRTTimestamp"></span></div>
            <div>Dicetak oleh: <span id="printRWRTUser">-</span></div>
        </div>
    </div>
</div>

<!-- Area untuk cetak PDF Girik Tagihan (disembunyikan default) -->
<div id="printGirikArea" style="display: none;" >
    <div class="print-page">
        <!-- Header -->
        <div class="print-header">
            <div class="print-title">GIRIK TAGIHAN PBB</div>
            <div class="print-subtitle">DESA CILAYUNG KECAMATAN JATINANGOR</div>
        </div>
        <!-- Info -->
        <div class="print-info">
            <div class="print-date" id="printDate"></div>
            <div class="print-filter" id="printFilter"></div>
        </div>
        <!-- Tabel -->
        <div class="print-table-container">
            <table class="print-table" id="printGirikTable">
                <thead>
                    <tr>
                        <th>NO</th>
                        <th>NOP</th>
                        <th>NAMA WAJIB PAJAK</th>
                        <th>ALAMAT WAJIB PAJAK</th>
                        <th>ALAMAT OBJEK PAJAK</th>
                        <th>POKOK PBB</th>
                        <th>TANGGAL BAYAR</th>
                        <th>KOLEKTOR</th>
                    </tr>
                </thead>
                <tbody id="printGirikTableBody">
                    <!-- Data akan diisi oleh JS -->
                </tbody>
            </table>
        </div>
        <!-- Ringkasan -->
        <div class="print-summary">
            <div>Total Jumlah PBB: <span id="printTotalPBB">0</span></div>
        </div>
        <!-- Footer -->
        <div class="print-footer">
            Dicetak pada: <span id="printTimestamp"></span>
        </div>
    </div>
</div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AOS Animation -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });

        // Konfigurasi
        const API_URL = 'https://script.google.com/macros/s/AKfycbzBb4SGIPzArcoy8LV5tG__SmKdz7sZdFktN9GI7FncCjuzNuh2bbKfFivfaMVKPRGLEw/exec';

        // Data kolektor (akan diisi dari API)
        let allData = [];
        let headers = [];
        let indexMap = {};
        let collectorsData = [];
        let sinkData = [];
        let currentPage = 1;
        let currentSinkPage = 1;
        let selectedRowIndex = -1;
        const rowsPerPage = 10;
        const sinkRowsPerPage = 10;

        // Format Rupiah
        function toRupiah(n) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                maximumFractionDigits: 0
            }).format(n || 0);
        }

        // Format tanggal Indonesia (DD/MM/YYYY)
        function formatTanggalIndonesia(tanggal) {
            if (!tanggal) return '-';
            try {
                const dateObj = new Date(tanggal);
                if (isNaN(dateObj.getTime())) {
                    return tanggal;
                }
                const hari = dateObj.getDate().toString().padStart(2, '0');
                const bulan = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                const tahun = dateObj.getFullYear();
                return `${hari}/${bulan}/${tahun}`;
            } catch (error) {
                console.error('Error formatting date:', error);
                return tanggal;
            }
        }

        // Dapatkan tanggal hari ini dalam format Indonesia
        function getHariIni() {
            const sekarang = new Date();
            const tahun = sekarang.getFullYear();
            const bulan = String(sekarang.getMonth() + 1).padStart(2, '0');
            const hari = String(sekarang.getDate()).padStart(2, '0');
            return `${hari}/${bulan}/${tahun}`;
        }

        // Tampilkan notifikasi toast
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = `custom-toast ${type} toast show`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">Notifikasi</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }

        // Dapatkan nama performa berdasarkan persentase
        function getPerformanceLabel(percentage) {
            if (percentage >= 50) return { label: "Excellent", class: "performance-excellent" };
            if (percentage >= 40) return { label: "Good", class: "performance-good" };
            if (percentage >= 30) return { label: "Average", class: "performance-average" };
            return { label: "Poor", class: "performance-poor" };
        }

// Tampilkan loading indicator dengan timeout
function showLoading(message = "Memuat data", submessage = "Harap tunggu sebentar...", timeout = 15000) {
    const overlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const loadingSubtext = document.getElementById('loadingSubtext');
    const progressBar = document.getElementById('loadingProgressBar');
    
    loadingText.textContent = message;
    loadingSubtext.textContent = submessage;
    progressBar.style.width = '30%';
    
    overlay.classList.remove('loading-hidden');
    
    // Animasi progress bar
    let progress = 30;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 5;
        if (progress < 90) {
            progressBar.style.width = progress + '%';
        }
    }, 500);
    
    // Simpan interval ID untuk membersihkan nanti
    overlay.dataset.progressInterval = progressInterval;
    
    // Timeout untuk mencegah loading terlalu lama
    overlay.dataset.timeout = setTimeout(() => {
        hideLoading();
        showToast('Proses memakan waktu lebih lama dari biasanya', 'warning');
    }, timeout);
}

// Sembunyikan loading indicator
function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    const progressBar = document.getElementById('loadingProgressBar');
    
    // Hentikan timeout jika ada
    if (overlay.dataset.timeout) {
        clearTimeout(parseInt(overlay.dataset.timeout));
        delete overlay.dataset.timeout;
    }
    
    // Hentikan interval progress
    if (overlay.dataset.progressInterval) {
        clearInterval(parseInt(overlay.dataset.progressInterval));
        delete overlay.dataset.progressInterval;
    }
    
    // Selesaikan progress bar
    progressBar.style.width = '100%';
    
    // Tunggu sebentar lalu sembunyikan
    setTimeout(() => {
        overlay.classList.add('loading-hidden');
        
        // Reset progress bar setelah animasi selesai
        setTimeout(() => {
            progressBar.style.width = '0%';
        }, 500);
    }, 500);
}
        // Tampilkan pesan error
        function showError(message) {
            const container = document.getElementById('collectorCardsContainer');
            if (!container) {
                console.error('Elemen collectorCardsContainer tidak ditemukan!');
                return;
            }
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger text-center">
                        <i class="bi bi-exclamation-triangle"></i> ${message}
                    </div>
                </div>
            `;
        }

        // Ambil data dari API
// Ambil data dari API
async function fetchData() {
  try {
    showLoading();
    const user = JSON.parse(localStorage.getItem("userData") || "{}");

    const formData = new URLSearchParams();
    formData.append("action", "getdata");
    formData.append("nama_lengkap", user.nama_lengkap || "");
    formData.append("desa", user.desa || "");
    formData.append("kecamatan", user.kecamatan || "");
    formData.append("role", user.role || "");
    formData.append("username", user.username || ""); // Tambahkan ini

    const response = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: formData
    });

    const result = await response.json();
    if (result.status === "success") {
      return result;
    } else {
      console.error("Gagal mengambil data", result.message);
      showError("Gagal mengambil " + result.message);
      return null;
    }
  } catch (error) {
    console.error("Error fetching data", error);
    showError("Terjadi kesalahan saat mengambil " + error.message);
    return null;
  }
}


        // Simpan data ke Google Sheets
// Simpan data ke Google Sheets dengan parameter userData
async function savePaymentToSheet(rowIndex, userData) {
  try {
    if (rowIndex < 0 || rowIndex >= allData.length) {
      console.error('Indeks baris tidak valid:', rowIndex);
      return false;
    }
    
    const row = allData[rowIndex];
    if (!row) {
      console.error('Data baris tidak ditemukan pada indeks:', rowIndex);
      return false;
    }
    
    if (!indexMap || typeof indexMap !== 'object') {
      console.error('indexMap belum diinisialisasi.');
      return false;
    }
    
    const nopColumnIndex = indexMap['NOP'];
    if (nopColumnIndex === undefined) {
      const nopKey = Object.keys(indexMap).find(key => key.toLowerCase() === 'nop');
      if (nopKey) {
        indexMap['NOP'] = indexMap[nopKey];
      } else {
        console.error('Kolom "NOP" tidak ditemukan. Tersedia:', Object.keys(indexMap));
        return false;
      }
    }
    
    const nop = row[indexMap['NOP']];
    if (!nop) {
      console.error('Nilai NOP kosong pada baris:', row);
      return false;
    }

    const formData = new URLSearchParams();
    formData.append('action', 'update');
    formData.append('nop', nop);
    formData.append('Status', 'Lunas');
    formData.append('Tanggal_Bayar', getHariIni());
    
    // TAMBAHKAN DATA USER YANG DIPERLUKAN UNTUK VALIDASI
    formData.append('nama_lengkap', userData.nama_lengkap || '');
    formData.append('desa', userData.desa || '');
    formData.append('kecamatan', userData.kecamatan || '');
    formData.append('role', userData.role || '');
    formData.append('username', userData.username || '');

    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
    }
    
    let result;
    try {
      result = await response.json();
    } catch (parseError) {
      console.warn('Gagal mem-parsing JSON, tapi respons HTTP OK. Asumsikan sukses.');
      return true;
    }
    
    if (result && (result.status === 'success' || result.message === 'Data berhasil diupdate')) {
      return true;
    } else {
      console.error('Respons dari server tidak menunjukkan keberhasilan:', result);
      return false;
    }
  } catch (error) {
    console.error('Error saving payment:', error);
    return false;
  }
}
        // Proses data untuk kolektor
        function processCollectorData(data) {
            if (!data || !data.values || data.values.length < 2) return [];
            headers = data.values[0];
            allData = data.values.slice(1);
            indexMap = {};
            headers.forEach((header, index) => {
                indexMap[header] = index;
            });
            if (!indexMap['Kolektor'] || !indexMap['Pokok_PBB'] || !indexMap['Status']) {
                showError('Struktur data tidak valid. Pastikan ada kolom: Kolektor, Pokok_PBB, Status');
                return [];
            }
            const kolektorMap = {};
            allData.forEach(row => {
                const kolektor = row[indexMap['Kolektor']] || 'PBB Bermasalah';
                const pokokPBB = parseFloat(row[indexMap['Pokok_PBB']] || 0);
                const status = (row[indexMap['Status']] || '').toString().toLowerCase();
                if (!kolektorMap[kolektor]) {
                    kolektorMap[kolektor] = {
                        name: kolektor,
                        target: 0,
                        realisasi: 0
                    };
                }
                kolektorMap[kolektor].target += pokokPBB;
                if (status === 'lunas') {
                    kolektorMap[kolektor].realisasi += pokokPBB;
                }
            });
            const collectors = Object.values(kolektorMap).map(k => {
                const percentage = k.target > 0 ? Math.min(100, Math.round((k.realisasi / k.target) * 100)) : 0;
                return {
                    name: k.name,
                    target: k.target,
                    realisasi: k.realisasi,
                    percentage: percentage
                };
            });
            return collectors;
        }

// Render grid card data
function renderGridCards(data, page = 1) {
    const gridContainer = document.getElementById('gridCardContainer');
    const tableInfo = document.getElementById('tableInfo');
    const pagination = document.getElementById('pagination');
    if (!data || data.length === 0) {
        gridContainer.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-inbox display-4 d-block text-muted mb-3"></i>
                <span class="text-muted">Tidak ada data yang tersedia</span>
            </div>
        `;
        tableInfo.textContent = 'Menampilkan 0 - 0 data';
        return;
    }

    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    // Filter data berdasarkan pencarian
    const filteredData = data.filter(row => {
        const nop = (row[indexMap['NOP']] || '').toString().toLowerCase();
        const namaWP = (row[indexMap['Nama_WP']] || '').toString().toLowerCase();
        return nop.includes(searchTerm) || namaWP.includes(searchTerm);
    });

    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
    currentPage = Math.max(1, Math.min(page, totalPages));
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
    const currentData = filteredData.slice(startIndex, endIndex);

    gridContainer.innerHTML = '';

    currentData.forEach((row, index) => {
        const absoluteIndex = startIndex + index; // Posisi absolut dalam filteredData
        const originalIndex = data.indexOf(row); // <-- DAPATKAN INDEX ASLI DALAM allData

        const nop = row[indexMap['NOP']] || 'Tidak diketahui';
        const namaWP = row[indexMap['Nama_WP']] || 'Tidak diketahui';
        const pokokPBB = parseFloat(row[indexMap['Pokok_PBB']] || 0);
        const tglBayar = row[indexMap['Tanggal_Bayar']];
        const status = (row[indexMap['Status']] || '').toString().toLowerCase();
        const kolektor = row[indexMap['Kolektor']] || 'Tidak diketahui';
        const formattedTglBayar = formatTanggalIndonesia(tglBayar);

        const card = document.createElement('div');
        card.className = 'grid-card card-hover';
        card.setAttribute('data-original-index', originalIndex); // <-- SIMPAN INDEX ASLI
        card.style.animationDelay = `${index * 0.1}s`;

        card.innerHTML = `
            <div class="grid-card-header">
                <h4 class="grid-card-title">${nop}</h4>
                <span class="grid-card-badge ${status === 'lunas' ? 'status-lunas' : 'status-belum'}">
                    ${status === 'lunas' ? 'Lunas' : 'Belum Bayar'}
                </span>
            </div>
            <div class="grid-card-content">
                <div class="grid-card-item">
                    <span class="grid-card-label">Nama WP:</span>
                    <span class="grid-card-value">${namaWP}</span>
                </div>
                <div class="grid-card-item">
                    <span class="grid-card-label">Pokok PBB:</span>
                    <span class="grid-card-value">${toRupiah(pokokPBB)}</span>
                </div>
                <div class="grid-card-item">
                    <span class="grid-card-label">Tanggal Bayar:</span>
                    <span class="grid-card-value">${formattedTglBayar}</span>
                </div>
            </div>
        `;

        // Tambahkan event listener klik
        card.addEventListener('click', (e) => {
            if (!e.target.closest('.btn-detail')) {
                const originalIndex = parseInt(card.getAttribute('data-original-index'));

                // Validasi index
                if (originalIndex < 0 || originalIndex >= allData.length) {
                    console.error('Index tidak valid:', originalIndex);
                    showToast('Data tidak ditemukan.', 'danger');
                    return;
                }

                showDetailModal(originalIndex); // <-- Kirim index asli ke showDetailModal
            }
        });

        gridContainer.appendChild(card);
    });

    tableInfo.textContent = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${filteredData.length} data`;
    renderPagination(totalPages);
}

        // Tampilkan modal detail
        function showDetailModal(index) {
                // --- VALIDASI INDEX ---
    if (index < 0 || index >= allData.length) {
        console.error('Index out of bounds:', index);
        showToast('Data tidak ditemukan.', 'danger');
        return;
    }
    // --- AKHIR VALIDASI ---

            selectedRowIndex = index;
            const row = allData[index];
            
    if (!row) {
        console.error('Data baris kosong pada index:', index);
        showToast('Data tidak ditemukan.', 'danger');
        return;
    }            
            const nop = row[indexMap['NOP']] || 'Tidak diketahui';
            const namaWP = row[indexMap['Nama_WP']] || 'Tidak diketahui';
            const alamatWP = row[indexMap['Alamat_WP']];
            const alamatObjek = row[indexMap['Alamat_Objek']];
            const pokokPBB = parseFloat(row[indexMap['Pokok_PBB']] || 0);
            const tglBayar = row[indexMap['Tanggal_Bayar']];
            const status = (row[indexMap['Status']] || '').toString().toLowerCase();
            const pemilik = row[indexMap['Pemilik']];
            const alamatPemilik = row[indexMap['Alamat_Pemilik']];
            const kolektor = row[indexMap['Kolektor']] || 'Tidak diketahui';
            const luastanah = row[indexMap['LT']] || '-';
            const luasbangunan = row[indexMap['LB']] || '-';
            
            // Format tanggal Indonesia
            const formattedTglBayar = formatTanggalIndonesia(tglBayar);
            const statusText = status === 'lunas' ? 'Lunas' : 'Belum Bayar';

            function formatLuas(angka) {
            if (!angka || isNaN(angka)) return "-";
            return Number(angka).toLocaleString("id-ID") + " m";
            }

            // ... di dalam fungsi showDetailModal ...
            // Isi modal dengan data
            document.getElementById('modalNOP').textContent = nop;
            document.getElementById('modalNama').textContent = namaWP;
            document.getElementById('modalAlamatWP').textContent = alamatWP;
            document.getElementById('modalAlamatObjek').textContent = alamatObjek;
            document.getElementById('modalPBB').textContent = toRupiah(pokokPBB);
            document.getElementById('modalluastanah').textContent = formatLuas(luastanah);
            document.getElementById('modalluasbangunan').textContent = formatLuas(luasbangunan);
            // --- PERBAIKAN: Update badge status ---
            const statusBadge = document.getElementById('modalStatusBadge');
            statusBadge.textContent = statusText;
            if (status === 'lunas') {
                statusBadge.className = 'badge rounded-pill px-2 py-1 fw-bold bg-success text-white';
            } else {
                statusBadge.className = 'badge rounded-pill px-2 py-1 fw-bold bg-danger text-white';
            }
            // --- AKHIR PERBAIKAN ---
            document.getElementById('modalTanggal').textContent = formattedTglBayar;
            document.getElementById('modalPemilik').textContent = pemilik;
            document.getElementById('modalAlamatPemilik').textContent = alamatPemilik;
            document.getElementById('modalKolektor').textContent = kolektor;
            
            // Tampilkan atau sembunyikan tombol bayar berdasarkan status
            const btnBayar = document.getElementById('btnBayar');
            if (status === 'lunas') {
                btnBayar.style.display = 'none';
            } else {
                btnBayar.style.display = 'block';
            }
            
            // Tampilkan modal
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
        }

        // Proses pembayaran
// Proses pembayaran
async function processPayment() {
  if (selectedRowIndex === -1) return;
  
  const row = allData[selectedRowIndex];
  if (!row) return;
  
  // Ambil data user dari localStorage
  const userData = JSON.parse(localStorage.getItem('userData') || '{}');
  
  // Validasi data user lengkap
  if (!userData.nama_lengkap || !userData.desa || !userData.kecamatan) {
    showToast('Data user tidak lengkap. Silakan login ulang.', 'danger');
    return;
  }

  const btnBayar = document.getElementById('btnBayar');
  const originalText = btnBayar.innerHTML;
  btnBayar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Memproses...';
  btnBayar.disabled = true;
  
  try {
    // Kirim data user yang diperlukan untuk validasi
    const success = await savePaymentToSheet(selectedRowIndex, userData);
    
    if (success) {
      row[indexMap['Status']] = 'Lunas';
      row[indexMap['Tanggal_Bayar']] = getHariIni();
      
      renderGridCards(allData, currentPage);
      collectorsData = processCollectorData({values: [headers, ...allData]});
      renderCollectorCards(collectorsData);
      updateSummaryStats(collectorsData);

      // Perbarui tabel sinkronisasi
      sinkData = processSinkData();
      renderSinkReportTable(sinkData);

      const modal = bootstrap.Modal.getInstance(document.getElementById('detailModal'));
      if (modal) modal.hide();
      
      showToast('Pembayaran berhasil diproses! Status telah diubah menjadi Lunas.', 'success');
    } else {
      showToast('Gagal memproses pembayaran.', 'danger');
    }
  } catch (error) {
    console.error('Error processing payment:', error);
    showToast('Terjadi kesalahan saat memproses pembayaran.', 'danger');
  } finally {
    btnBayar.innerHTML = originalText;
    btnBayar.disabled = false;
  }
}

        // Render pagination
        function renderPagination(totalPages) {
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            let paginationHTML = `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
                </li>
            `;
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
                </li>
            `;
            pagination.innerHTML = paginationHTML;
            pagination.querySelectorAll('.page-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = parseInt(link.getAttribute('data-page'));
                    if (!isNaN(page)) {
                        renderGridCards(allData, page);
                    }
                });
            });
        }


        // Render kartu kolektor
        function renderCollectorCards(data) {
            const container = document.getElementById('collectorCardsContainer');
            if (!container) {
                console.error('Elemen collectorCardsContainer tidak ditemukan!');
                return;
            }
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle"></i> Tidak ada data kolektor yang ditemukan.
                        </div>
                    </div>
                `;
                return;
            }

            const sortedData = [...data].sort((a, b) => b.percentage - a.percentage);

            sortedData.forEach((collector, index) => {
                const performance = getPerformanceLabel(collector.percentage);
                const cardId = `collector-${collector.name.replace(/\s+/g, '-').toLowerCase()}`;

                const col = document.createElement('div');
                col.className = 'col-xl-3 col-lg-4 col-md-6 mb-4';
                col.id = cardId;
                col.setAttribute('data-collector', collector.name);
                col.setAttribute('data-aos', 'fade-up');
                col.setAttribute('data-aos-delay', index * 100);

                col.addEventListener('click', () => {
                    document.querySelectorAll('.collector-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    col.querySelector('.collector-card').classList.add('active');
                });

                col.innerHTML = `
                    <div class="collector-card card-hover">
                        <div class="card-header">
                            <h3 class="collector-name">${collector.name}</h3>
                            <span class="performance-badge ${performance.class}">${performance.label}</span>
                        </div>

                        <div class="progress-container">
                            <div class="progress-label">
                                <span class="progress-value">Realisasi: ${toRupiah(collector.realisasi)}</span>
                                <span class="progress-value">Target: ${toRupiah(collector.target)}</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar"
                                    style="width: ${collector.percentage}%; background-color: ${getProgressColor(collector.percentage)};"
                                    aria-valuenow="${collector.percentage}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <div class="progress-percentage" style="color: ${getProgressColor(collector.percentage)};">
                                ${collector.percentage}% Tercapai
                            </div>
                        </div>

                        <div class="chart-container">
                            <canvas id="chart-${collector.name.replace(/\s+/g, '-').toLowerCase()}"></canvas>
                        </div>
                    </div>
                `;

                container.appendChild(col);

                setTimeout(() => {
                    renderCollectorChart(collector);
                }, 100);
            });

            updateSummaryStats(sortedData);

            // Isi dropdown filter kolektor di laporan sink
            const collectorFilter = document.getElementById('collectorFilter');
            if (collectorFilter) {
                // Simpan opsi yang sudah ada (Semua Kolektor)
                const firstOption = collectorFilter.options[0];
                // Hapus semua opsi kecuali yang pertama
                collectorFilter.innerHTML = '';
                collectorFilter.appendChild(firstOption);
                
                // Tambahkan opsi untuk setiap kolektor
                sortedData.forEach(collector => {
                    const option = document.createElement('option');
                    option.value = collector.name;
                    option.textContent = collector.name;
                    collectorFilter.appendChild(option);
                });
            }

        }

        // Warna progress bar berdasarkan persentase
        function getProgressColor(percentage) {
            if (percentage >= 50) return '#00d478';
            if (percentage >= 40) return '#44b0f4';
            if (percentage >= 30) return '#ffd700';
            return '#ff3366';
        }

        // Render chart untuk setiap kolektor
        function renderCollectorChart(collector) {
            const canvasId = `chart-${collector.name.replace(/\s+/g, '-').toLowerCase()}`;
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [''],
                    datasets: [{
                        label: 'Realisasi',
                        data: [collector.realisasi],
                        backgroundColor: getProgressColor(collector.percentage),
                        borderRadius: 8,
                        borderSkipped: false
                    }, {
                        label: 'Sisa Target',
                        data: [Math.max(0, collector.target - collector.realisasi)],
                        backgroundColor: '#e9ecef',
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 8,
                                boxHeight: 8,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.raw;
                                    return `${label}: ${toRupiah(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                display: false
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                display: false
                            },
                            grid: {
                                drawTicks: false,
                                drawBorder: false
                            }
                        }
                    }
                }
            });
        }

        // Update statistik summary
        function updateSummaryStats(data) {
            const totalWP = allData ? allData.length : 0;
            const totalTarget = data.reduce((sum, collector) => sum + collector.target, 0);
            const totalRealisasi = data.reduce((sum, collector) => sum + collector.realisasi, 0);
            const averageAchievement = totalTarget > 0 ? Math.round((totalRealisasi / totalTarget) * 100) : 0;
            document.getElementById('totalCollectors').textContent = totalWP.toLocaleString();
            document.getElementById('totalTarget').textContent = toRupiah(totalTarget);
            document.getElementById('totalRealisasi').textContent = toRupiah(totalRealisasi);
            document.getElementById('averageAchievement').textContent = `${averageAchievement}%`;
        }

        // Toggle theme (light/dark mode)
        function setupThemeToggle() {
            const themeSwitcher = document.getElementById('themeSwitcher');
            const icon = themeSwitcher.querySelector('i');
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-bs-theme', savedTheme);
                icon.className = savedTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-bs-theme', 'dark');
                icon.className = 'bi bi-sun-fill';
            }
            themeSwitcher.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-bs-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                icon.className = newTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
            });
        }

        // Proses data untuk laporan sink
        function processSinkData() {
            if (!allData || allData.length === 0) return [];
            
            // Pastikan indexMap memiliki referensi ke kolom yang diperlukan
            const requiredColumns = ['Status', 'Tanggal_Bayar', 'Sink_Date'];
            for (const col of requiredColumns) {
                if (!indexMap[col]) {
                    console.error(`Kolom ${col} tidak ditemukan dalam data`);
                    showToast(`Kolom ${col} tidak ditemukan dalam data`, 'warning');
                    return [];
                }
            }
            
            return allData.map(row => {
                const nop = row[indexMap['NOP']] || 'Tidak diketahui';
                const tahun = row[indexMap['Tahun']] || 'Tidak diketahui';
                const namaWP = row[indexMap['Nama_WP']] || 'Tidak diketahui';
                const alamatWP = row[indexMap['Alamat_WP']] || 'Tidak diketahui';
                const alamatOP = row[indexMap['Alamat_Objek']] || 'Tidak diketahui';
                const tanggalBayar = row[indexMap['Tanggal_Bayar']] || '';
                const pokokPBB = parseFloat(row[indexMap['Pokok_PBB']] || 0);
                const pemilik = row[indexMap['Pemilik']] || 'Tidak diketahui';
                const alamatPemilik = row[indexMap['Alamat_Pemilik']] || 'Tidak diketahui';
                const kolektor = row[indexMap['Kolektor']] || 'Tidak diketahui';
                const lt = row[indexMap['LT']] || '-';
                const lb = row[indexMap['LB']] || '-';
                const desa = row[indexMap['Desa']] || 'Tidak diketahui';
                
                // Ambil data status dan sink
                const status = (row[indexMap['Status']] || '').toString().toLowerCase();
                const sinkDate = row[indexMap['Sink_Date']] || '';
                
                // Tentukan status sinkronisasi berdasarkan logika yang diberikan
                let sinkStatus;
                if (status === 'belum') {
                    sinkStatus = 'Belum Bayar';
                } else if (status === 'lunas') {
                    // Jika status lunas, periksa sink date
                    if (sinkDate) {
                        sinkStatus = 'Sinkron';
                    } else {
                        sinkStatus = 'Menunggu';
                    }
                } else {
                    sinkStatus = 'Status Tidak Dikenal';
                }
                
                return {
                    nop,
                    tahun,
                    namaWP,
                    alamatWP,
                    alamatOP,
                    pokokPBB,
                    tanggalBayar: formatTanggalIndonesia(tanggalBayar),
                    sinkStatus,
                    sinkDate: sinkDate ? formatTanggalIndonesia(sinkDate) : '-',
                    kolektor,
                    pemilik,
                    alamatPemilik,
                    desa,
                    lt,
                    lb,
                    status // Simpan status asli untuk filtering
                };
            });
        }
        // Render tabel laporan sink
        function renderSinkReportTable(data, page = 1) {
            const tableBody = document.getElementById('sinkReportTableBody');
            const tableInfo = document.getElementById('sinkTableInfo');
            const pagination = document.getElementById('sinkPagination');
            const totalPokokPBBElement = document.getElementById('totalPokokPBB'); // <-- BARU: Elemen untuk total
            if (!data || data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center py-4">
                            <i class="bi bi-inbox display-5 d-block text-muted mb-2"></i>
                            <span class="text-muted">Tidak ada data sinkronisasi</span>
                        </td>
                    </tr>
                `;
                tableInfo.textContent = 'Menampilkan 0 - 0 data';
                if (totalPokokPBBElement) {
                    totalPokokPBBElement.textContent = 'Rp 0'; // <-- BARU: Set total ke 0
                }
                return;
            }
            // Filter data berdasarkan status
            const statusFilter = document.getElementById('sinkStatusFilter').value;
            let filteredData = data;
            if (statusFilter !== 'all') {
                filteredData = data.filter(item => item.sinkStatus === statusFilter);
            }
            // Filter data berdasarkan tanggal bayar (bukan sink date)
            const dateFilter = document.getElementById('paymentDateFilter').value;
            if (dateFilter !== 'all') {
                const today = new Date();
                filteredData = filteredData.filter(item => {
                    // Skip jika tidak ada tanggal bayar atau status "Belum Bayar"
                    if (item.tanggalBayar === '-' || item.sinkStatus === 'Belum Bayar') return false;
                    // Parse tanggal bayar (format: DD/MM/YYYY)
                    const parts = item.tanggalBayar.split('/');
                    if (parts.length !== 3) return false;
                    const paymentDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                    switch (dateFilter) {
                        case 'today':
                            return paymentDate.toDateString() === today.toDateString();
                        case 'week':
                            const oneWeekAgo = new Date();
                            oneWeekAgo.setDate(today.getDate() - 7);
                            return paymentDate >= oneWeekAgo && paymentDate <= today;
                        case 'month':
                            const oneMonthAgo = new Date();
                            oneMonthAgo.setMonth(today.getMonth() - 1);
                            return paymentDate >= oneMonthAgo && paymentDate <= today;
                        default:
                            return true;
                    }
                });
            }
            // Filter data berdasarkan kolektor
            const collectorFilterValue = document.getElementById('collectorFilter').value;
            if (collectorFilterValue !== 'all') {
                filteredData = filteredData.filter(item => item.kolektor === collectorFilterValue);
            }
            // Pagination
            const totalPages = Math.ceil(filteredData.length / sinkRowsPerPage);
            currentSinkPage = Math.max(1, Math.min(page, totalPages));
            const startIndex = (currentSinkPage - 1) * sinkRowsPerPage;
            const endIndex = Math.min(startIndex + sinkRowsPerPage, filteredData.length);
            const currentData = filteredData.slice(startIndex, endIndex);
            function formatLuas(angka) {
                if (!angka || isNaN(angka)) return "-";
                return Number(angka).toLocaleString("id-ID") + " m";
            }
            // Render table rows
            tableBody.innerHTML = '';
            currentData.forEach((item, index) => {
                const row = document.createElement('tr');
                // Tentukan class status sink
                let statusClass;
                switch (item.sinkStatus) {
                    case 'Sinkron':
                        statusClass = 'sink-synced';
                        break;
                    case 'Menunggu':
                        statusClass = 'sink-pending';
                        break;
                    case 'Belum Bayar':
                        statusClass = 'sink-not-paid';
                        break;
                    default:
                        statusClass = 'sink-pending';
                }
                row.innerHTML = `
                    <td style="text-align: center;">${item.nop}</td>
                    <td style="text-align: center;">${item.tahun}</td>
                    <td style="text-align: left;">${item.namaWP}</td>
                    <td style="text-align: left;">${item.alamatWP}</td>
                    <td style="text-align: left;">${item.alamatOP}</td>
                    <td style="text-align: center;">${item.desa}</td>
                    <td style="text-align: right;">${Number(item.pokokPBB).toLocaleString("id-ID")}</td>
                    <td style="text-align: right;">${formatLuas(item.lt)}</td>
                    <td style="text-align: right;">${formatLuas(item.lb)}</td> 
                    <td style="text-align: center;">${item.tanggalBayar}</td>
                    <td style="text-align: center;"><span class="sink-status ${statusClass}">${item.sinkStatus}</span></td>
                    <td style="text-align: left;">${item.kolektor}</td>
                `;
                tableBody.appendChild(row);
            });
            // Hitung total Pokok PBB dari data yang difilter
            const totalPokokPBB = filteredData.reduce((sum, item) => sum + (Number(item.pokokPBB) || 0), 0);
            // Tampilkan total Pokok PBB
            if (totalPokokPBBElement) {
                totalPokokPBBElement.textContent = toRupiah(totalPokokPBB);
            }
            // Update table info
            tableInfo.textContent = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${filteredData.length} data`;
            // Render pagination
            renderSinkPagination(totalPages);
        }
        // Render pagination untuk tabel sink
        function renderSinkPagination(totalPages) {
            const pagination = document.getElementById('sinkPagination');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            let paginationHTML = `
                <li class="page-item ${currentSinkPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentSinkPage - 1}">Previous</a>
                </li>
            `;
            const startPage = Math.max(1, currentSinkPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentSinkPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            paginationHTML += `
                <li class="page-item ${currentSinkPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentSinkPage + 1}">Next</a>
                </li>
            `;
            pagination.innerHTML = paginationHTML;
            // Add event listeners to pagination links
            pagination.querySelectorAll('.page-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = parseInt(link.getAttribute('data-page'));
                    if (!isNaN(page)) {
                        renderSinkReportTable(sinkData, page);
                    }
                });
            });
        }
        // Muat ulang data
async function refreshData() {
  showLoading("Memperbarui data", "Mengambil data terbaru...", 20000);
  try {
    const data = await fetchData();
    if (data) {
      collectorsData = processCollectorData(data);
      renderCollectorCards(collectorsData);
      renderGridCards(allData);
      
      sinkData = processSinkData();
      renderSinkReportTable(sinkData);
      
      renderRekapRWRTTable();
      renderRekapKolektorTable();
      
      //  PANGGIL DI SINI - Setelah data selesai dimuat
      checkSyncDataAndUpdateButton();
    }
  } catch (error) {
    showError('Gagal memuat data: ' + error.message);
  } finally {
    hideLoading();
  }
}
        // Fungsi untuk mencetak ke PDF - DIPERBAIKI TOTAL
/**
 * Cetak PDF Laporan Sinkronisasi  DENGAN PENGECEKAN KESIAPAN DATA
 */
// Fungsi untuk cetak PDF RW RT
function cetakLaporan() {
    // Siapkan data untuk print
    preparePrintData();
    
    // Tampilkan area print
    const printArea = document.getElementById("printArea");
    printArea.style.display = "block";
    
    // Tunggu sebentar agar render selesai
    setTimeout(() => {
        window.print();
        
        // Sembunyikan lagi setelah print
        setTimeout(() => {
            printArea.style.display = "none";
        }, 500);
    }, 500);
}

// Event listener untuk tombol print
document.addEventListener("DOMContentLoaded", function() {
    const btnPrintPDF = document.getElementById('btnPrintPDF');
    if (btnPrintPDF) {
        btnPrintPDF.addEventListener('click', printArea);
    }
});

// Siapkan data untuk dicetak - DIPERBAIKI TOTAL
// Siapkan data untuk dicetak - PERBAIKI INI
function preparePrintData() {
    try {
        const printDate = document.getElementById('printDate');
        const printFilter = document.getElementById('printFilter');
        const printTableBody = document.getElementById('printTableBody');
        const printTimestamp = document.getElementById('printTimestamp');
        const printTotalData = document.getElementById('printTotalData');
        const printSynced = document.getElementById('printSynced');
        const printPending = document.getElementById('printPending');
        const printNotPaid = document.getElementById('printNotPaid');
        const printTotalPBB = document.getElementById('printTotalPBB');

        // Set tanggal laporan
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        printDate.textContent = `Tanggal: ${now.toLocaleDateString('id-ID', options)}`;
        printTimestamp.textContent = now.toLocaleString('id-ID');

        // Ambil filter yang aktif
        const statusFilter = document.getElementById('sinkStatusFilter');
        const dateFilter = document.getElementById('paymentDateFilter');
        const collectorFilter = document.getElementById('collectorFilter');
        
        let filterText = '';
        if (statusFilter && statusFilter.value !== 'all') {
            filterText += `Status: ${statusFilter.options[statusFilter.selectedIndex].text}`;
        }
        if (dateFilter && dateFilter.value !== 'all') {
            if (filterText !== '') filterText += ', ';
            filterText += `Tanggal: ${dateFilter.options[dateFilter.selectedIndex].text}`;
        }
        if (collectorFilter && collectorFilter.value !== 'all') {
            if (filterText !== '') filterText += ', ';
            filterText += `Kolektor: ${collectorFilter.options[collectorFilter.selectedIndex].text}`;
        }
        if (filterText === '') {
            filterText = 'Semua Data';
        }
        
        if (printFilter) printFilter.textContent = filterText;

        // Pastikan sinkData ada dan tidak kosong
        if (!sinkData || sinkData.length === 0) {
            if (printTableBody) printTableBody.innerHTML = '<tr><td colspan="10" class="text-center">Tidak ada data</td></tr>';
            if (printTotalData) printTotalData.textContent = '0';
            if (printSynced) printSynced.textContent = '0';
            if (printPending) printPending.textContent = '0';
            if (printNotPaid) printNotPaid.textContent = '0';
            if (printTotalPBB) printTotalPBB.textContent = '0';
            return;
        }

        // Ambil data yang difilter
        let filteredData = [...sinkData];

        // Filter berdasarkan status
        if (statusFilter && statusFilter.value !== 'all') {
            filteredData = filteredData.filter(item => item.sinkStatus === statusFilter.value);
        }

        // Filter berdasarkan tanggal bayar
        if (dateFilter && dateFilter.value !== 'all') {
            const today = new Date();
            filteredData = filteredData.filter(item => {
                if (item.tanggalBayar === '-' || item.sinkStatus === 'Belum Bayar') return false;
                
                try {
                    const parts = item.tanggalBayar.split('/');
                    if (parts.length !== 3) return false;
                    
                    const paymentDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                    if (isNaN(paymentDate.getTime())) return false;

                    switch (dateFilter.value) {
                        case 'today':
                            return paymentDate.toDateString() === today.toDateString();
                        case 'week':
                            const oneWeekAgo = new Date();
                            oneWeekAgo.setDate(today.getDate() - 7);
                            return paymentDate >= oneWeekAgo && paymentDate <= today;
                        case 'month':
                            const oneMonthAgo = new Date();
                            oneMonthAgo.setMonth(today.getMonth() - 1);
                            return paymentDate >= oneMonthAgo && paymentDate <= today;
                        default:
                            return true;
                    }
                } catch (e) {
                    return false;
                }
            });
        }

        // Filter berdasarkan kolektor
        if (collectorFilter && collectorFilter.value !== 'all') {
            filteredData = filteredData.filter(item => item.kolektor === collectorFilter.value);
        }

        // Isi tabel cetak
        if (printTableBody) {
            printTableBody.innerHTML = '';
            filteredData.forEach((item, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center;">${idx + 1}</td>
                    <td style="text-align: center;">${item.nop}</td>
                    <td style="text-align: center;">${item.tahun}</td>
                    <td style="text-align: left;">${item.namaWP}</td>
                    <td style="text-align: left;">${item.alamatWP}</td>
                    <td style="text-align: left;">${item.alamatOP}</td>
                    <td style="text-align: center;">${item.desa}</td>
                    <td style="text-align: right;">${Number(item.pokokPBB).toLocaleString("id-ID")}</td>
                    <td style="text-align: center;">${item.tanggalBayar}</td>
                    <td style="text-align: left;">${item.kolektor}</td>
                `;
                printTableBody.appendChild(row);
            });
        }

        // Hitung summary
        const totalData = filteredData.length;
        const syncedCount = filteredData.filter(item => item.sinkStatus === 'Sinkron').length;
        const pendingCount = filteredData.filter(item => item.sinkStatus === 'Menunggu').length;
        const notPaidCount = filteredData.filter(item => item.sinkStatus === 'Belum Bayar').length;
        const totalPBB = filteredData.reduce((sum, item) => sum + (Number(item.pokokPBB) || 0), 0);

        // Update summary
        if (printTotalData) printTotalData.textContent = totalData.toString();
        if (printSynced) printSynced.textContent = syncedCount.toString();
        if (printPending) printPending.textContent = pendingCount.toString();
        if (printNotPaid) printNotPaid.textContent = notPaidCount.toString();
        if (printTotalPBB) printTotalPBB.textContent = totalPBB.toLocaleString('id-ID');

    } catch (error) {
        console.error('Error preparing print data:', error);
        showToast('Error menyiapkan data cetak', 'danger');
    }
}
        // Fungsi untuk mengelola sidebar
        function setupSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const body = document.body;
            
            // Toggle sidebar
            function toggleSidebar() {
                sidebar.classList.toggle('show');
                sidebarOverlay.classList.toggle('show');
                body.classList.toggle('sidebar-visible');
            }
            
            // Event listeners
            if (sidebarToggle && sidebarOverlay) {
                sidebarToggle.addEventListener('click', toggleSidebar);
                sidebarOverlay.addEventListener('click', toggleSidebar);
            }
            
            // Menu navigation
            const navLinks = document.querySelectorAll('.nav-link:not(.logout)');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    // Add active class to clicked link
                    this.classList.add('active');
                    // Get the target section
                    const targetSection = this.getAttribute('data-section');
                    // Navigate to the section
                    navigateToSection(targetSection);
                    // Tutup sidebar setelah klik menu (di semua ukuran layar)
                    toggleSidebar();
                });
            });
            // Logout from sidebar
            document.getElementById('sidebarLogout').addEventListener('click', function(e) {
                e.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('logoutConfirmModal'));
                modal.show();
                
                // On mobile, close sidebar after selection
                if (window.innerWidth < 992) {
                    toggleSidebar();
                }
            });
            
            // Navigate to section function
            function navigateToSection(section) {
                // Semua section yang mungkin
                const allSections = [
                    'dashboardStats', 
                    'collectorCardsContainer', 
                    'gridCardSection', 
                    'sinkReportSection',
                    'rekapRWRTSection', // <-- Tambahkan section Rekap RW & RT
                    'rekapKolektorSection',
                    'girikSection'
                ];
                // Sembunyikan semua section terlebih dahulu
                allSections.forEach(sectionId => {
                    const element = document.getElementById(sectionId);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
                // Tampilkan section yang dipilih berdasarkan menu yang diklik
                if (section === 'dashboard') {
                    // Tampilkan hanya statistik dashboard dan kartu kolektor
                    document.getElementById('dashboardStats').style.display = 'flex';
                    document.getElementById('collectorCardsContainer').style.display = 'flex';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } 
                else if (section === 'bayar') {
                    // Tampilkan hanya tabel grid (data detail wajib pajak)
                    document.getElementById('gridCardSection').style.display = 'block';
                    window.scrollTo({ top: document.getElementById('gridCardSection').offsetTop, behavior: 'smooth' });
                }
                else if (section === 'laporan') {
                    // Tampilkan hanya laporan sinkronisasi
                    document.getElementById('sinkReportSection').style.display = 'block';
                    window.scrollTo({ top: document.getElementById('sinkReportSection').offsetTop, behavior: 'smooth' });
                }
                else if (section === 'rekap-rw-rt') {
                    // Tampilkan hanya rekap RW & RT
                    document.getElementById('rekapRWRTSection').style.display = 'block';
                    window.scrollTo({ top: document.getElementById('rekapRWRTSection').offsetTop, behavior: 'smooth' });
                }
                else if (section === 'rekap-kolektor') {
                    // Tampilkan hanya rekap per kolektor
                    document.getElementById('rekapKolektorSection').style.display = 'block';
                    window.scrollTo({ top: document.getElementById('rekapKolektorSection').offsetTop, behavior: 'smooth' });
                }
                    else if (section === 'girik') { //  TAMBAHKAN INI
                    navigateToGirikSection(); //  Panggil fungsi khusus
                }
                }
            
            
                // Initially show dashboard and update user info
                navigateToSection('dashboard');
                updateUserInfo();

                // Sembunyikan menu Manajemen Petugas jika bukan admin
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                const userRole = (userData.role || '').toLowerCase();
                if (userRole !== 'admin') {
                const manageUserLink = document.querySelector('a[href="#"][data-bs-toggle="modal"][data-bs-target="#userModal"]');
                if (manageUserLink) {
                    manageUserLink.closest('li').style.display = 'none';
                }
                // Sembunyikan menu Laporan jika bukan admin
                const sinkReportSection = document.querySelector('a[href="#"][data-section="laporan"]');
                if (sinkReportSection) {
                    sinkReportSection.closest('li').style.display = 'none';
                }
                // Sembunyikan menu rekap per kolektor jika bukan admin
                const rekapKolektorSection = document.querySelector('a[href="#"][data-section="laporan"]');
                if (rekapKolektorSection) {
                    rekapKolektorSection.closest('li').style.display = 'none';
                }
                }

            }



// Perbaiki fungsi processRekapRWRT untuk menghitung dengan benar
function processRekapRWRT(data) {
    if (!data || data.length === 0) return [];
    
    const rwMap = {};
    
    data.forEach(row => {
        const alamatPemilik = row[indexMap['Alamat_Pemilik']] || 'Alamat Tidak Diketahui';
        const pokokPBB = parseFloat(row[indexMap['Pokok_PBB']] || 0);
        const status = (row[indexMap['Status']] || '').toString().toLowerCase();
        
        // Pastikan pokokPBB adalah number yang valid
        if (isNaN(pokokPBB)) {
            console.warn('Invalid Pokok_PBB value:', row[indexMap['Pokok_PBB']]);
            return; // Skip invalid data
        }
        
        // Ekstrak RW dan RT dari alamat pemilik
        let rw = '';
        let rt = '';
        
        const rwMatch = alamatPemilik.match(/RW\s+(\d+)/i);
        const rtMatch = alamatPemilik.match(/RT\s+(\d+)/i);
        
        if (rwMatch && rwMatch[1]) {
            rw = `RW ${rwMatch[1].padStart(2, '0')}`;
        }
        if (rtMatch && rtMatch[1]) {
            rt = `RT ${rtMatch[1].padStart(2, '0')}`;
        }
        
        // Inisialisasi RW
        if (!rwMap[rw]) {
            rwMap[rw] = {
                alamat: rw,
                jumlahWP: 0,
                totalPBB: 0,
                realisasi: 0,
                rtMap: {}
            };
        }
        
        // Inisialisasi RT
        if (!rwMap[rw].rtMap[rt]) {
            rwMap[rw].rtMap[rt] = {
                alamat: rt,
                jumlahWP: 0,
                totalPBB: 0,
                realisasi: 0
            };
        }
        
        // Update data RW
        rwMap[rw].jumlahWP++;
        rwMap[rw].totalPBB += pokokPBB;
        if (status === 'lunas') {
            rwMap[rw].realisasi += pokokPBB;
        }
        
        // Update data RT
        rwMap[rw].rtMap[rt].jumlahWP++;
        rwMap[rw].rtMap[rt].totalPBB += pokokPBB;
        if (status === 'lunas') {
            rwMap[rw].rtMap[rt].realisasi += pokokPBB;
        }
    });
    
    // Konversi ke array dan hitung persentase
    const result = [];
    let no = 1;
    
    Object.keys(rwMap)
        .sort((a, b) => {
            const aNum = parseInt(a.replace(/\D/g, '')) || 0;
            const bNum = parseInt(b.replace(/\D/g, '')) || 0;
            return aNum - bNum;
        })
        .forEach(rwKey => {
            const rw = rwMap[rwKey];
            const persenRealisasi = rw.totalPBB > 0 ? Math.round((rw.realisasi / rw.totalPBB) * 100) : 0;
            const sisa = rw.totalPBB - rw.realisasi;
            const persenSisa = rw.totalPBB > 0 ? Math.round((sisa / rw.totalPBB) * 100) : 0;
            
            // Tambahkan baris RW
            result.push({
                alamat: rw.alamat,
                jumlahWP: rw.jumlahWP,
                totalPBB: rw.totalPBB,
                realisasi: rw.realisasi,
                persenRealisasi: persenRealisasi,
                sisa: sisa,
                persenSisa: persenSisa,
                type: 'rw'
            });
            
            // Tambahkan baris RT
            Object.keys(rw.rtMap)
                .sort((a, b) => {
                    const aNum = parseInt(a.replace(/\D/g, '')) || 0;
                    const bNum = parseInt(b.replace(/\D/g, '')) || 0;
                    return aNum - bNum;
                })
                .forEach(rtKey => {
                    const rt = rw.rtMap[rtKey];
                    const rtPersenRealisasi = rt.totalPBB > 0 ? Math.round((rt.realisasi / rt.totalPBB) * 100) : 0;
                    const rtSisa = rt.totalPBB - rt.realisasi;
                    const rtPersenSisa = rt.totalPBB > 0 ? Math.round((rtSisa / rt.totalPBB) * 100) : 0;
                    
                    result.push({
                        alamat: ` ${rt.alamat}`,
                        jumlahWP: rt.jumlahWP,
                        totalPBB: rt.totalPBB,
                        realisasi: rt.realisasi,
                        persenRealisasi: rtPersenRealisasi,
                        sisa: rtSisa,
                        persenSisa: rtPersenSisa,
                        type: 'rt'
                    });
                });
        });
    
    return result;
}

// Parse tanggal dari banyak format, normalisasi ke midnight local
function parseDateFromString(dateStr) {
    if (!dateStr) return null;
    if (dateStr instanceof Date && !isNaN(dateStr.getTime())) {
        return new Date(dateStr.getFullYear(), dateStr.getMonth(), dateStr.getDate());
    }
    if (typeof dateStr !== 'string') return null;
    const s = dateStr.trim();
    // format dd/mm/yyyy atau d/m/yyyy
    if (s.includes('/')) {
        const parts = s.split('/');
        if (parts.length >= 3) {
            const d = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10) - 1;
            const y = parseInt(parts[2], 10);
            if (!isNaN(d) && !isNaN(m) && !isNaN(y)) return new Date(y, m, d);
        }
    }
    // coba parse ISO / lainnya, lalu normalisasi ke tanggal
    const parsed = new Date(s);
    if (!isNaN(parsed.getTime())) {
        return new Date(parsed.getFullYear(), parsed.getMonth(), parsed.getDate());
    }
    return null;
}

// Helper: parse angka/pokokPBB yang mungkin punya pemisah ribuan (dot) => jadi number
function parseNumber(value) {
    if (value === null || value === undefined) return 0;
    if (typeof value === 'number') return value;
    let s = String(value).trim();
    if (s === '') return 0;
    s = s.replace(/Rp/gi, '').replace(/\s/g, '');
    // jika ada titik dan tidak ada koma -> anggap titik sebagai pemisah ribuan
    if (s.indexOf('.') > -1 && s.indexOf(',') === -1) {
        s = s.replace(/\./g, '');
    } else {
        // hapus titik, ubah koma jadi titik (untuk decimal)
        s = s.replace(/\./g, '').replace(/,/g, '.');
    }
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
}

// panggil sekali saat halaman load
setRekapKolektorHeaders();


// Proses data rekap per Kolektor (menghitung 7-day dan kumulatif s.d hari ini)
function processRekapKolektor(data) {
    if (!data || data.length === 0) return [];

    const kolektorMap = {};
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const startRentang1 = new Date(today);
    startRentang1.setDate(today.getDate() - 6); // 7 hari termasuk hari ini

    data.forEach(row => {
        const kolektor = (row[indexMap['Kolektor']] || 'Tidak Diketahui').toString().trim();
        const rawPokok = row[indexMap['Pokok_PBB']];
        const pokokPBB = parseNumber(rawPokok); // pastikan parseNumber ada
        const status = (row[indexMap['Status']] || '').toString().toLowerCase();
        const tanggalBayarRaw = row[indexMap['Tanggal_Bayar']] || '';

        let masukRentang1 = false;
        let masukKumulatif = false;

        if (status === 'lunas' && tanggalBayarRaw && String(tanggalBayarRaw).trim() !== '-') {
            const paidDate = parseDateFromString(tanggalBayarRaw); // pastikan helper ada
            if (paidDate) {
                if (paidDate >= startRentang1 && paidDate <= today) masukRentang1 = true;
                if (paidDate <= today) masukKumulatif = true; // kumulatif sampai hari ini
            }
        }

        if (!kolektorMap[kolektor]) {
            kolektorMap[kolektor] = {
                nama: kolektor,
                targetSPPT: 0,
                targetRp: 0,
                realisasiRentang1SPPT: 0,
                realisasiRentang1Rp: 0,
                realisasiRentang2SPPT: 0,
                realisasiRentang2Rp: 0
            };
        }

        // Target (pastikan increment angka)
        kolektorMap[kolektor].targetSPPT += 1;
        kolektorMap[kolektor].targetRp += Number(pokokPBB || 0);

        // Realiazi 7-day
        if (masukRentang1) {
            kolektorMap[kolektor].realisasiRentang1SPPT += 1;
            kolektorMap[kolektor].realisasiRentang1Rp += Number(pokokPBB || 0);
        }
        // Realiazi kumulatif sampai hari ini
        if (masukKumulatif) {
            kolektorMap[kolektor].realisasiRentang2SPPT += 1;
            kolektorMap[kolektor].realisasiRentang2Rp += Number(pokokPBB || 0);
        }
    });

    // Siapkan array sebelum menambahkan nomor urut
    let result = Object.keys(kolektorMap).map(kname => {
        const k = kolektorMap[kname];
        const targetRp = Number(k.targetRp || 0);
        const r1Rp = Number(k.realisasiRentang1Rp || 0);
        const r2Rp = Number(k.realisasiRentang2Rp || 0);
        const sisaRp = targetRp - r2Rp;

        const persenRentang1 = targetRp > 0 ? (r1Rp / targetRp) * 100 : 0;
        const persenRentang2 = targetRp > 0 ? (r2Rp / targetRp) * 100 : 0;
        const persenSisa = targetRp > 0 ? (sisaRp / targetRp) * 100 : 0;

        return {
            nama: k.nama,
            targetSPPT: Number(k.targetSPPT || 0),
            targetRp: targetRp,

            realisasiRentang1SPPT: Number(k.realisasiRentang1SPPT || 0),
            realisasiRentang1Rp: r1Rp,
            persenRentang1: Number(persenRentang1.toFixed(2)),

            realisasiRentang2SPPT: Number(k.realisasiRentang2SPPT || 0),
            realisasiRentang2Rp: r2Rp,
            persenRentang2: Number(persenRentang2.toFixed(2)),

            sisaSPPT: Number(k.targetSPPT || 0) - Number(k.realisasiRentang2SPPT || 0),
            sisaRp: sisaRp,
            persenSisa: Number(persenSisa.toFixed(2))
        };
    });

    // Urutan custom
    const order = ["DEDE IRAWAN", "RONI", "AHMAD SIHABUDIN", "BERMASALAH"];

    // Sort sesuai urutan
    result.sort((a, b) => order.indexOf(a.nama.toUpperCase()) - order.indexOf(b.nama.toUpperCase()));

    // Tambahkan nomor urut setelah sort
    result = result.map((item, idx) => ({ no: idx + 1, ...item }));

    return result;
}


function formatAngka(value) {
    if (isNaN(value)) return '0';
    return value.toLocaleString('id-ID'); // contoh: 1234567 -> "1.234.567"
}

// Render tabel rekap per Kolektor
function renderRekapKolektorTable() {
    const tableBody = document.getElementById('rekapKolektorTableBody');
    const tableInfo = document.getElementById('rekapKolektorInfo');
    if (!allData || allData.length === 0) {
        tableBody.innerHTML = `
            <tr><td colspan="13" class="text-center py-4">
            <i class="bi bi-inbox display-5 d-block text-muted mb-2"></i>
            <span class="text-muted">Tidak ada data</span></td></tr>`;
        tableInfo.textContent = 'Menampilkan 0 data';
        return;
    }

    const rekapData = processRekapKolektor(allData);
    tableBody.innerHTML = '';

    // Render baris
    rekapData.forEach(item => {
        const row = document.createElement('tr');

        // pastikan semua field numeric adalah Number
        const targetRp = Number(item.targetRp || 0);
        const r1Rp = Number(item.realisasiRentang1Rp || 0);
        const r2Rp = Number(item.realisasiRentang2Rp || 0);
        const sisaRp = Number(item.sisaRp || 0);

        row.innerHTML = `
            <td data-label="No :" style="text-align: center;">${item.no}</td>
            <td data-label="Nama :" style="text-align:left;">${item.nama}</td>
            <td data-label="Target SPPT :" style="text-align:center;">${item.targetSPPT}</td>
            <td data-label="Target PBB :" style="text-align:right;">${formatAngka(targetRp)}</td>

            <td data-label="R. SPPT Minggu ini :" style="text-align:center;">${item.realisasiRentang1SPPT}</td>
            <td data-label="R. PBB Minggu ini :" style="text-align:right;">${formatAngka(r1Rp)}</td>
            <td data-label="% R. Minggu ini :" style="text-align:center;">${Number(item.persenRentang1).toFixed(2)}%</td>

            <td data-label="Total R. SPPT :" style="text-align:center;">${item.realisasiRentang2SPPT}</td>
            <td data-label="Total R. PBB :" style="text-align:right;">${formatAngka(r2Rp)}</td>
            <td data-label="% Total Realisasi" style="text-align:center;">${Number(item.persenRentang2).toFixed(2)}%</td>

            <td data-label="Sisa SPPT :" style="text-align:center;">${item.sisaSPPT}</td>
            <td data-label="Sisa PBB :" style="text-align:right;">${formatAngka(sisaRp)}</td>
            <td data-label="% Sisa :" style="text-align:center;">${Number(item.persenSisa).toFixed(2)}%</td>
        `;
        tableBody.appendChild(row);
    });

    // Hitung totals (pastikan menggunakan Number)
    let totalTargetSPPT = 0;
    let totalTargetRp = 0;
    let totalR1SPPT = 0;
    let totalR1Rp = 0;
    let totalR2SPPT = 0;
    let totalR2Rp = 0;
    let totalSisaSPPT = 0;
    let totalSisaRp = 0;

    rekapData.forEach(it => {
        totalTargetSPPT += Number(it.targetSPPT || 0);
        totalTargetRp += Number(it.targetRp || 0);
        totalR1SPPT += Number(it.realisasiRentang1SPPT || 0);
        totalR1Rp += Number(it.realisasiRentang1Rp || 0);
        totalR2SPPT += Number(it.realisasiRentang2SPPT || 0);
        totalR2Rp += Number(it.realisasiRentang2Rp || 0);
        totalSisaSPPT += Number(it.sisaSPPT || 0);
        totalSisaRp += Number(it.sisaRp || 0);
    });

    // Persen totals: rentang2 adalah kumulatif (dipakai sebagai % total)
    const persenTotalR1 = totalTargetRp > 0 ? ((totalR1Rp / totalTargetRp) * 100).toFixed(2) : '0.00';
    const persenTotalR2 = totalTargetRp > 0 ? ((totalR2Rp / totalTargetRp) * 100).toFixed(2) : '0.00';
    const persenTotalSisa = totalTargetRp > 0 ? ((totalSisaRp / totalTargetRp) * 100).toFixed(2) : '0.00';

    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML = `
        <td colspan="2"><strong>TOTAL</strong></td>
        <td style="text-align:center;"><strong>${totalTargetSPPT}</strong></td>
        <td style="text-align:right;"><strong>${formatAngka(totalTargetRp)}</strong></td>

        <td style="text-align:center;"><strong>${totalR1SPPT}</strong></td>
        <td style="text-align:right;"><strong>${formatAngka(totalR1Rp)}</strong></td>
        <td style="text-align:center;"><strong>${persenTotalR1}%</strong></td>

        <td style="text-align:center;"><strong>${totalR2SPPT}</strong></td>
        <td style="text-align:right;"><strong>${formatAngka(totalR2Rp)}</strong></td>
        <td style="text-align:center;"><strong>${persenTotalR2}%</strong></td>

        <td style="text-align:center;"><strong>${totalSisaSPPT}</strong></td>
        <td style="text-align:right;"><strong>${formatAngka(totalSisaRp)}</strong></td>
        <td style="text-align:center;"><strong>${persenTotalSisa}%</strong></td>
    `;
    tableBody.appendChild(totalRow);

    tableInfo.textContent = `Menampilkan ${rekapData.length} data`;
}

// Export Excel untuk Rekap Kolektor
document.getElementById('btnExportExcelKolektor')?.addEventListener('click', function() {
    const rekapData = processRekapKolektor(allData);
    if (rekapData.length === 0) {
        showToast('Tidak ada data yang dapat diunduh', 'warning');
        return;
    }

    const worksheet = XLSX.utils.json_to_sheet(rekapData.map(item => ({
        "NO": item.no,
        "NAMA KOLEKTOR": item.nama,
        "TARGET SPPT": item.targetSPPT,
        "TARGET Rp": item.targetRp,

        "REALISASI 01-11 SPPT": item.realisasiRentang1SPPT,
        "REALISASI 01-11 Rp": item.realisasiRentang1Rp,
        "REALISASI 01-11 %": `${item.persenRentang1}%`,

        "REALISASI 12 SPPT": item.realisasiRentang2SPPT,
        "REALISASI 12 Rp": item.realisasiRentang2Rp,
        "REALISASI 12 %": `${item.persenRentang2}%`,

        "SISA SPPT": item.sisaSPPT,
        "SISA Rp": item.sisaRp,
        "SISA %": `${item.persenSisa}%`
    })));

    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Rekap Per Kolektor");
    const today = new Date();
    const fileName = `Rekap_Per_Kolektor_${today.toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(workbook, fileName);
    showToast('Rekap Per Kolektor berhasil diunduh', 'success');
});


// Rentang tanggal untuk header (tampilannya)
function getTanggalRentang() {
    const sekarang = new Date();
    const tahun = sekarang.getFullYear();
    const bulan = sekarang.getMonth();
    const namaBulan = [
        'Januari','Februari','Maret','April','Mei','Juni',
        'Juli','Agustus','September','Oktober','November','Desember'
    ][bulan];

    const hariIni = sekarang.getDate();

    // Rentang 1 = 7 hari terakhir termasuk hari ini
    const start = new Date(sekarang);
    start.setDate(sekarang.getDate() - 6); // mundur 6 hari + hari ini = 7 hari
    const rentang1 = `TGL ${start.getDate()} - ${hariIni} ${namaBulan.toUpperCase()} ${tahun}`;

    // Rentang 2 = kumulatif sampai hari ini (label)
    const rentang2 = `S.D TGL ${hariIni} ${namaBulan.toUpperCase()} ${tahun}`;

    return { rentang1, rentang2 };
}

// Pasang rentang di header tabel
function setRekapKolektorHeaders() {
    const { rentang1, rentang2 } = getTanggalRentang();
    document.getElementById("rentang1Header").textContent = rentang1;
    document.getElementById("rentang2Header").textContent = rentang2;
}



// Fungsi untuk mencetak ke PDF
document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("cetakRekapKolektor");
    if (btn) {
        btn.addEventListener("click", cetakRekapKolektor);
    }
});

function cetakRekapKolektor() {
    // Isi data ke tabel
    preparePrintDataKolektor();

    // Update timestamp
    const now = new Date();
    document.getElementById("printTimestampKolektor").innerText = now.toLocaleString('id-ID');

    // Tampilkan area print
    const printArea = document.getElementById("printAreaKolektor");
    printArea.style.display = "block";

    // Tunggu browser render, lalu cetak
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            window.print();
            printArea.style.display = "none"; // sembunyikan lagi setelah cetak
        });
    });
}




// Siapkan data untuk cetak PDF
// Siapkan data untuk dicetak
function preparePrintDataKolektor() {
    const printDate = document.getElementById('printDateKolektor');
    const printTableBody = document.getElementById('printTableBodyKolektor');
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    printDate.textContent = `Tanggal: ${now.toLocaleDateString('id-ID', options)}`;

    const rekapData = processRekapKolektor(allData);
    printTableBody.innerHTML = '';

    rekapData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="text-align: center;">${item.no}</td>
            <td style="text-align: left;">${item.nama}</td>
            <td style="text-align:center;">${item.targetSPPT}</td>
            <td style="text-align:right;">${formatAngka(item.targetRp)}</td>

            <td style="text-align:center;">${item.realisasiRentang1SPPT}</td>
            <td style="text-align:right;">${formatAngka(item.realisasiRentang1Rp)}</td>
            <td style="text-align:center;">${item.persenRentang1}%</td>

            <td style="text-align:center;">${item.realisasiRentang2SPPT}</td>
            <td style="text-align:right;">${formatAngka(item.realisasiRentang2Rp)}</td>
            <td style="text-align:center;">${item.persenRentang2}%</td>

            <td style="text-align:center;">${item.sisaSPPT}</td>
            <td style="text-align:right;">${formatAngka(item.sisaRp)}</td>
            <td style="text-align:center;">${item.persenSisa}%</td>
        `;
        printTableBody.appendChild(row);
    });

    // Hitung total keseluruhan
    let totalTargetSPPT = 0, totalTargetRp = 0;
    let totalR1SPPT = 0, totalR1Rp = 0;
    let totalR2SPPT = 0, totalR2Rp = 0;
    let totalSisaSPPT = 0, totalSisaRp = 0;

    rekapData.forEach(it => {
        totalTargetSPPT += Number(it.targetSPPT || 0);
        totalTargetRp += Number(it.targetRp || 0);
        totalR1SPPT += Number(it.realisasiRentang1SPPT || 0);
        totalR1Rp += Number(it.realisasiRentang1Rp || 0);
        totalR2SPPT += Number(it.realisasiRentang2SPPT || 0);
        totalR2Rp += Number(it.realisasiRentang2Rp || 0);
        totalSisaSPPT += Number(it.sisaSPPT || 0);
        totalSisaRp += Number(it.sisaRp || 0);
    });

    const persenTotalR1 = totalTargetRp > 0 ? ((totalR1Rp / totalTargetRp) * 100).toFixed(2) : '0.00';
    const persenTotalR2 = totalTargetRp > 0 ? ((totalR2Rp / totalTargetRp) * 100).toFixed(2) : '0.00';
    const persenTotalSisa = totalTargetRp > 0 ? ((totalSisaRp / totalTargetRp) * 100).toFixed(2) : '0.00';

    // Tambahkan baris total
    const totalRow = document.createElement('tr');
    totalRow.className = 'total-row';
    totalRow.innerHTML = `
        <td colspan="2"><strong>TOTAL</strong></td>
        <td style="text-align:center;"><strong>${totalTargetSPPT}</strong></td>
        <td style="text-align:right;"><strong>${formatAngka(totalTargetRp)}</strong></td>

        <td style="text-align:center;"><strong>${totalR1SPPT}</strong></td>
        <td style="text-align:right;"><strong>${formatAngka(totalR1Rp)}</strong></td>
        <td style="text-align:center;"><strong>${persenTotalR1}%</strong></td>

        <td style="text-align:center;"><strong>${totalR2SPPT}</strong></td>
        <td style="text-align:right;"><strong>${formatAngka(totalR2Rp)}</strong></td>
        <td style="text-align:center;"><strong>${persenTotalR2}%</strong></td>

        <td style="text-align:center;"><strong>${totalSisaSPPT}</strong></td>
        <td style="text-align:right;"><strong>${formatAngka(totalSisaRp)}</strong></td>
        <td style="text-align:center;"><strong>${persenTotalSisa}%</strong></td>
    `;
    printTableBody.appendChild(totalRow);
}
      
            // Render tabel rekap RW & RT
            function renderRekapRWRTTable() {
                const tableBody = document.getElementById('rekapRWRTTableBody');
                const tableInfo = document.getElementById('rekapRWRTInfo');
                
                if (!allData || allData.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <i class="bi bi-inbox display-5 d-block text-muted mb-2"></i>
                                <span class="text-muted">Tidak ada data</span>
                            </td>
                        </tr>
                    `;
                    tableInfo.textContent = 'Menampilkan 0 data';
                    return;
                }
                
                const rekapData = processRekapRWRT(allData);
                
                tableBody.innerHTML = '';
                rekapData.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = item.type === 'rw' ? 'rw-row' : 'rt-row';
                    
                    row.innerHTML = `
                        <td data-label="Alamat :">${item.alamat}</td>
                        <td data-label="Jumlah WP :" style="text-align: center;">${item.jumlahWP}</td>
                        <td data-label="Total PBB :" style="text-align: right;">${toRupiah(item.totalPBB)}</td>
                        <td data-label="Realisasi :" style="text-align: right;">${toRupiah(item.realisasi)}</td>
                        <td data-label="% Realisasi :" style="text-align: center; color: ${item.persenRealisasi >= 50 ? '#00d478' : '#ff3366'};">
                            ${item.persenRealisasi}%
                        </td>
                        <td data-label="Sisa :" style="text-align: right;">${toRupiah(item.sisa)}</td>
                        <td data-label="% Sisa" style="text-align: center; color: ${item.persenSisa >= 50 ? '#ff3366' : '#00d478'};">
                            ${item.persenSisa}%
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Hitung total keseluruhan
                let totalWP = 0;
                let totalPBB = 0;
                let totalRealisasi = 0;
                let totalSisa = 0;
                
                rekapData.forEach(item => {
                    if (item.type === 'rw') {
                        totalWP += item.jumlahWP;
                        totalPBB += item.totalPBB;
                        totalRealisasi += item.realisasi;
                        totalSisa += item.sisa;
                    }
                });
                
                // Tambahkan baris total
                const totalRow = document.createElement('tr');
                totalRow.className = 'total-row';
                totalRow.innerHTML = `
                    <td style="text-align: "center;>TOTAL</td>
                    <td data-label="Total WP :" style="text-align: center;">${totalWP}</td>
                    <td data-label="Total PBB :" style="text-align: center;">${toRupiah(totalPBB)}</td>
                    <td data-label="Total Realisasi :" style="text-align: center;">${toRupiah(totalRealisasi)}</td>
                    <td data-label="Total % Realisasi :" style="text-align: center;">
                        ${totalPBB > 0 ? Math.round((totalRealisasi / totalPBB) * 100) : 0}%
                    </td>
                    <td data-label="Total Sisa :" style="text-align: center;">${toRupiah(totalSisa)}</td>
                    <td data-label="Total % Realisasi :" style="text-align: center;">
                        ${totalPBB > 0 ? Math.round((totalSisa / totalPBB) * 100) : 0}%
                    </td>
                `;
                tableBody.appendChild(totalRow);
                
                tableInfo.textContent = `Menampilkan ${rekapData.length} data`;
            }

            // Export Excel untuk Rekap RW & RT
            document.getElementById('btnExportExcelRWRT')?.addEventListener('click', function() {
                const rekapData = processRekapRWRT(allData);
                if (rekapData.length === 0) {
                    showToast('Tidak ada data yang dapat diunduh', 'warning');
                    return;
                }
                
                const worksheet = XLSX.utils.json_to_sheet(rekapData.map(item => ({
                    "Alamat Pemilik": item.alamat,
                    "Jumlah WP": item.jumlahWP,
                    "Total PBB": item.totalPBB,
                    "Realisasi": item.realisasi,
                    "Persen Realisasi": `${item.persenRealisasi}%`,
                    "Sisa": item.sisa,
                    "Persen Sisa": `${item.persenSisa}%`
                })));
                
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Rekap RW & RT");
                
                const today = new Date();
                const fileName = `Rekap_RW_RT_${today.toISOString().split('T')[0]}.xlsx`;
                
                XLSX.writeFile(workbook, fileName);
                showToast('Rekap RW & RT berhasil diunduh', 'success');
            });

            // INISIALISASI DASHBOARD
            async function initDashboard() {
            // Setup sidebar
            setupSidebar();
            
            // Setup logout confirmation
            document.getElementById('confirmLogoutBtn').addEventListener('click', function() {
                const modalElement = document.getElementById('logoutConfirmModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                setTimeout(() => {
                    localStorage.clear();
                    window.location.href = 'QWEN.html';
                }, 300);
            });
            // Sembunyikan semua section kecuali dashboard saat inisialisasi
            const allSections = [
                'dashboardStats', 
                'collectorCardsContainer', 
                'gridCardSection', 
                'sinkReportSection'
            ];
            // Sembunyikan semua section terlebih dahulu
            allSections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) {
                    element.style.display = 'none';
                }
            });
            // Tampilkan hanya statistik dashboard dan kartu kolektor
            document.getElementById('dashboardStats').style.display = 'flex';
            document.getElementById('collectorCardsContainer').style.display = 'flex';

            // Load data
            try {
                const data = await fetchData();
                if (data) {
                    collectorsData = processCollectorData(data);
                    renderCollectorCards(collectorsData);
                    renderGridCards(allData);
                    // Process and render sink data
                    sinkData = processSinkData();
                    renderSinkReportTable(sinkData);
                }
            } catch (error) {
                showError('Gagal memuat data: ' + error.message);
            } finally {
                hideLoading();
            }

            // Setup filter event listeners untuk tabel sink
            document.getElementById('sinkStatusFilter').addEventListener('change', () => {
                renderSinkReportTable(sinkData, 1);
            });
            document.getElementById('paymentDateFilter').addEventListener('change', () => {
                renderSinkReportTable(sinkData, 1);
            });
            // Setup filter kolektor event listener
            document.getElementById('collectorFilter').addEventListener('change', () => {
                renderSinkReportTable(sinkData, 1);
            });
            // Setup tombol cetak PDF
            document.getElementById('btnPrintPDF').addEventListener('click', cetakLaporan);
            // Inisialisasi tooltip Bootstrap
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
            setupThemeToggle();
            document.getElementById('searchInput').addEventListener('input', () => {
                renderGridCards(allData, 1);
            });
            document.getElementById('btnBayar').addEventListener('click', processPayment);
            document.getElementById('refreshData').addEventListener('click', refreshData);
            await refreshData();
            // Setup toggle grid card button - YANG DIPERBAIKI
            const gridCardSection = document.getElementById('gridCardSection');
            const dashboardStats = document.getElementById('dashboardStats');
            const collectorCardsContainer = document.getElementById('collectorCardsContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            // Setup tombol export Excel
            // Setup tombol export Excel
            document.getElementById('btnExportExcel').addEventListener('click', function() {
                // Ambil data yang sudah difilter
                const statusFilter = document.getElementById('sinkStatusFilter').value;
                const dateFilter = document.getElementById('paymentDateFilter').value;
                let filteredData = [...sinkData];
                // Filter berdasarkan status
                if (statusFilter !== 'all') {
                    filteredData = filteredData.filter(item => item.sinkStatus === statusFilter);
                }
                // Filter berdasarkan tanggal bayar
                if (dateFilter !== 'all') {
                    const today = new Date();
                    filteredData = filteredData.filter(item => {
                        if (item.tanggalBayar === '-' || item.sinkStatus === 'Belum Bayar') return false;
                        const parts = item.tanggalBayar.split('/');
                        if (parts.length !== 3) return false;
                        const paymentDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                        switch (dateFilter) {
                            case 'today':
                                return paymentDate.toDateString() === today.toDateString();
                            case 'week':
                                const oneWeekAgo = new Date();
                                oneWeekAgo.setDate(today.getDate() - 7);
                                return paymentDate >= oneWeekAgo && paymentDate <= today;
                            case 'month':
                                const oneMonthAgo = new Date();
                                oneMonthAgo.setMonth(today.getMonth() - 1);
                                return paymentDate >= oneMonthAgo && paymentDate <= today;
                            default:
                                return true;
                        }
                    });
                }
                if (filteredData.length === 0) {
                    showToast('Tidak ada data yang dapat diunduh', 'warning');
                    return;
                }
                // Tambahkan kolom "No" ke dalam data
                const dataWithNo = filteredData.map((item, index) => ({
                    "No": index + 1, // <-- Tambahkan kolom "No"
                    "NOP": item.nop,
                    "Tahun": item.tahun,
                    "Nama Wajib Pajak": item.namaWP,
                    "Alamat Wajib Pajak": item.alamatWP,
                    "Alamat Objek Pajak": item.alamatOP,
                    "Desa": item.desa,
                    "Jumlah PBB": item.pokokPBB,
                    "Tanggal Bayar": item.tanggalBayar,
                    "Kolektor": item.kolektor
                }));
                // Buat worksheet dari data
                const worksheet = XLSX.utils.json_to_sheet(dataWithNo);
                // Buat workbook dan tambahkan worksheet
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan PBB"); 
                // Generate nama file
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                let fileName = `Laporan_PBB_${dateStr}`;
                // Tambahkan filter ke nama file jika ada
                if (statusFilter !== 'all') {
                    fileName += `_${statusFilter.replace(/\s+/g, '_')}`;
                }
                if (dateFilter !== 'all') {
                    fileName += `_${dateFilter}`;
                }
                fileName += ".xlsx";
                // Unduh file
                XLSX.writeFile(workbook, fileName);
                showToast('Laporan berhasil diunduh dalam format Excel', 'success');
            });

            // Render rekap RW & RT saat data dimuat
            renderRekapRWRTTable();
            // Render rekap per kolektor saat data dimuat
            renderRekapKolektorTable();

            // Inisialisasi Girik Tagihan
            populateGirikPemilikList();
            renderGirikTable([]);

            // Setup filter untuk Girik
            document.getElementById('sinkStatusFilter').addEventListener('change', () => {
                renderSinkReportTable(sinkData, 1);
            });
            document.getElementById('paymentDateFilter').addEventListener('change', () => {
                renderSinkReportTable(sinkData, 1);
            });
            document.getElementById('collectorFilter').addEventListener('change', () => {
                renderSinkReportTable(sinkData, 1);
            });

            }
            // --- KODE LOGIN ---
            function showLoginAlert(message) {
            const alertDiv = document.getElementById('loginAlert');
            alertDiv.textContent = message;
            alertDiv.classList.remove('d-none');
            }

async function handleLogin(username, password) {
  try {
    const formData = new URLSearchParams();
    formData.append('action', 'login');
    formData.append('username', username);
    formData.append('password', password);
    
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: formData
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      // PERBAIKAN: Gunakan result.data bukan result.userData
      const userData = result.data || {};
      
      // Simpan data user ke localStorage
      localStorage.setItem('isLoggedIn', 'true');
      localStorage.setItem('userData', JSON.stringify({
        username: userData.username || username,
        nama_lengkap: userData.nama_lengkap || username,
        role: userData.role || 'User',
        desa: userData.desa || '',
        kecamatan: userData.kecamatan || ''
      }));
      
      // Sembunyikan form login, tampilkan dashboard
      document.getElementById('loginContainer').classList.add('d-none');
      document.getElementById('dashboardContainer').classList.remove('d-none');
      
      // Inisialisasi dashboard
      initDashboard();
    } else {
      showLoginAlert(result.message || 'Login gagal. Silakan coba lagi.');
    }
  } catch (error) {
    console.error('Error:', error);
    showLoginAlert('Terjadi kesalahan jaringan. Silakan coba lagi.');
  }
}
    // Update user info in sidebar
function updateUserInfo() {
  try {
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    const userName = userData.nama_lengkap || userData.username || 'User';
    const userRole = userData.role || 'User';
    const userDesa = userData.desa || '-';
    const userKecamatan = userData.kecamatan || '-';
    const userInitial = userName.charAt(0).toUpperCase();
    
    document.getElementById('userName').textContent = userName;
    document.getElementById('userRole').textContent = `${userRole} - ${userDesa}, ${userKecamatan}`;
    document.getElementById('userAvatar').textContent = userInitial;
  } catch (e) {
    console.error('Error loading user data:', e);
  }
}
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const btn = this.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            if (!username || !password) {
                showLoginAlert('Username dan password wajib diisi.');
                return;
            }
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Memproses...';
            btn.disabled = true;
            handleLogin(username, password).finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });
        // Cek session saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userData = localStorage.getItem('userData');
            if (isLoggedIn === 'true' && userData) {
                try {
                    JSON.parse(userData);
                    document.getElementById('loginContainer').classList.add('d-none');
                    document.getElementById('dashboardContainer').classList.remove('d-none');
                    initDashboard();
                } catch (e) {
                    localStorage.clear();
                }
            }
        });

// === ANIMASI COUNT-UP UNTUK STATISTIK ===
function animateStats() {
    const statCards = document.querySelectorAll('.stat-card');
    statCards.forEach((card, index) => {
        // Tambahkan delay index untuk animasi muncul
        card.style.setProperty('--index', index);
        
        // Ambil elemen h2 (angka statistik)
        const statNumber = card.querySelector('h2');
        if (statNumber) {
            // Ambil nilai numerik dari teks (hapus "Rp" dan simbol lainnya)
            let text = statNumber.textContent || '';
            let value = 0;
            
            if (text.includes('Rp')) {
                // Untuk nilai uang
                value = parseFloat(text.replace(/[^\d]/g, '')) || 0;
            } else if (text.includes('%')) {
                // Untuk persentase
                value = parseFloat(text.replace(/[^\d]/g, '')) || 0;
            } else {
                // Untuk angka biasa
                value = parseInt(text.replace(/[^\d]/g, '')) || 0;
            }
            
            // Set custom property --target
            statNumber.style.setProperty('--target', value);
            
            // Reset teks menjadi 0 sebelum animasi
            if (text.includes('Rp')) {
                statNumber.textContent = 'Rp 0';
            } else if (text.includes('%')) {
                statNumber.textContent = '0%';
            } else {
                statNumber.textContent = '0';
            }
            
            // Mulai animasi setelah sedikit delay
            setTimeout(() => {
                animateValue(statNumber, 0, value, 2000, text.includes('Rp'), text.includes('%'));
            }, 300 + (index * 200));
        }
    });
}

// Fungsi animasi count-up
function animateValue(element, start, end, duration, isCurrency = false, isPercentage = false) {
    const startTime = performance.now();
    
    function updateValue(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Ease-out cubic
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const currentValue = Math.floor(start + (end - start) * easeOut);
        
        if (isCurrency) {
            element.textContent = `Rp ${currentValue.toLocaleString('id-ID')}`;
        } else if (isPercentage) {
            element.textContent = `${currentValue}%`;
        } else {
            element.textContent = currentValue.toLocaleString('id-ID');
        }
        
        if (progress < 1) {
            requestAnimationFrame(updateValue);
        }
    }
    
    requestAnimationFrame(updateValue);
}

// Panggil fungsi animateStats setelah data dimuat
function updateSummaryStats(data) {
    const totalWP = allData ? allData.length : 0;
    const totalTarget = data.reduce((sum, collector) => sum + collector.target, 0);
    const totalRealisasi = data.reduce((sum, collector) => sum + collector.realisasi, 0);
    const averageAchievement = totalTarget > 0 ? Math.round((totalRealisasi / totalTarget) * 100) : 0;
    
    document.getElementById('totalCollectors').textContent = totalWP.toLocaleString();
    document.getElementById('totalTarget').textContent = toRupiah(totalTarget);
    document.getElementById('totalRealisasi').textContent = toRupiah(totalRealisasi);
    document.getElementById('averageAchievement').textContent = `${averageAchievement}%`;
    
    // Mulai animasi setelah nilai diupdate
    setTimeout(() => {
        animateStats();
    }, 100);
}

// <!-- Update Nama, Alamat, Kolektor (mirip update pembayaran) -->
// Ganti kode yang ada dengan ini:
document.addEventListener('DOMContentLoaded', function() {
  // Gunakan event delegation pada document
  document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'btnUpdateDetail') {
      const btn = e.target;
      
      // Inisialisasi mode jika belum ada
      if (!btn.dataset.mode) {
        btn.dataset.mode = 'view';
      }

      const editableFields = [
        {id: 'modalPemilik', label: 'pemilik'},
        {id: 'modalAlamatPemilik', label: 'alamatPemilik'},
        {id: 'modalKolektor', label: 'kolektor'}
      ];

      if (btn.dataset.mode === 'view') {
        // ubah span jadi input
        editableFields.forEach(f => {
          const span = document.getElementById(f.id);
          if (span) {
            const currentValue = span.textContent.trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control form-control-sm';
            input.value = currentValue;
            input.dataset.field = f.label;
            span.replaceWith(input);
          }
        });

        btn.textContent = 'Simpan';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        btn.dataset.mode = 'edit';

      } else {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const updatedData = {};
        
        editableFields.forEach(f => {
          const input = document.querySelector(`input[data-field="${f.label}"]`);
          if (input) {
            const newValue = input.value.trim();
            const span = document.createElement('span');
            span.id = f.id;
            span.className = 'fw-semibold';
            span.textContent = newValue;
            updatedData[f.label] = newValue;
            input.replaceWith(span);
          }
        });

        const formData = new URLSearchParams();
        formData.append("action", "update");
        formData.append("nop", document.getElementById("modalNOP").textContent.trim());
        formData.append("Pemilik", updatedData.pemilik || "");
        formData.append("Alamat_Pemilik", updatedData.alamatPemilik || "");
        formData.append("Kolektor", updatedData.kolektor || "");
        
        // TAMBAHKAN DATA YANG DIPERLUKAN
        formData.append("nama_lengkap", userData.nama_lengkap || "");
        formData.append("desa", userData.desa || "");
        formData.append("kecamatan", userData.kecamatan || "");
        formData.append("role", userData.role || "");
        formData.append("username", userData.username || "");

        fetch(API_URL, {
          method: "POST",
          body: formData
        })
        .then(res => res.json())
        .then(res => {
          if (res.status === "success") {
            showToast(" Data berhasil diupdate di Spreadsheet!", "success");
            // Refresh data
            refreshData();
          } else {
            showToast(" Gagal update: " + res.message, "danger");
          }
        })
        .catch(err => {
          console.error("Fetch error:", err);
          showToast(" Error kirim data: " + err, "danger");
        });
        
        btn.textContent = 'Update';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-primary');
        btn.dataset.mode = 'view';
      }
    }
  });
});

// ==================== MANAJEMEN PETUGAS ====================

// Inisialisasi ketika DOM siap
document.addEventListener("DOMContentLoaded", function() {
    setupUserManagement();
});

function setupUserManagement() {
    // Setup modal user management
    const userModal = document.getElementById('userModal');
    if (userModal) {
        userModal.addEventListener('show.bs.modal', function() {
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            const userRole = (userData.role || '').toLowerCase();
            
            if (userRole !== 'admin') {
                document.querySelector('[data-bs-target="#addUserModal"]').style.display = 'none';
                document.getElementById('userTableBody').innerHTML = 
                    `<tr><td colspan="7" class="text-danger">Hanya admin yang dapat mengakses fitur ini</td></tr>`;
            } else {
                document.querySelector('[data-bs-target="#addUserModal"]').style.display = 'block';
                loadUsers();
            }
        });
    }

    // Setup form tambah petugas
    const addUserForm = document.getElementById('addUserForm');
    if (addUserForm) {
        addUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            handleAddUserSubmit(this);
        });
    }

    // Reset form ketika modal ditutup
    const addUserModal = document.getElementById('addUserModal');
    if (addUserModal) {
        addUserModal.addEventListener('hidden.bs.modal', function() {
            const form = document.getElementById('addUserForm');
            if (form) form.reset();
        });
    }
}

function handleAddUserSubmit(form) {
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    const userRole = (userData.role || '').toLowerCase();
    
    if (userRole !== 'admin') {
        showToast("Hanya admin yang dapat menambah petugas", "danger");
        return;
    }
    
    const formData = new FormData(form);
    const formValues = Object.fromEntries(formData.entries());
    
    // Validasi
    if (!formValues.username || !formValues.nama || !formValues.password || !formValues.role) {
        showToast('Harap isi semua field yang wajib diisi (*)', 'warning');
        return;
    }
    
    // Panggil fungsi addUser
    addUser(
        formValues.username,
        formValues.nama,
        formValues.password,
        formValues.role,
        formValues.jabatan,
        formValues.desa,
        formValues.kecamatan
    );
    
    // Tutup modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
    if (modal) modal.hide();
}

// Fungsi load users
function loadUsers() {
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    const userTableBody = document.getElementById('userTableBody');
    
    if (!userTableBody) {
        console.error('Element userTableBody tidak ditemukan');
        return;
    }
    
    userTableBody.innerHTML = `<tr><td colspan="7" class="text-center">Loading...</td></tr>`;
    
    const formData = new URLSearchParams();
    formData.append("action", "manageuser");
    formData.append("type", "list");
    formData.append("currentUser", userData.username || "admin");
    
    fetch(API_URL, { method: "POST", body: formData })
        .then((res) => res.json())
        .then((res) => {
            console.log("Response dari server:", res);
            
            if (res.status === "success") {
                const users = res.data || [];
                renderUsers(users);
            } else {
                userTableBody.innerHTML = `<tr><td colspan="7" class="text-danger">${res.message}</td></tr>`;
            }
        })
        .catch((err) => {
            console.error("Fetch error:", err);
            userTableBody.innerHTML = `<tr><td colspan="7" class="text-danger">Error load data: ${err.message}</td></tr>`;
        });
}

// Fungsi render users
// Fungsi renderUsers dengan null checking yang lebih robust
function renderUsers(users) {
    const userTableBody = document.getElementById('userTableBody');
    if (!userTableBody) {
        console.error('ERROR: userTableBody element not found');
        return;
    }
    
    userTableBody.innerHTML = "";
    
    if (!Array.isArray(users)) {
        userTableBody.innerHTML = `<tr><td colspan="7" class="text-danger">Format data tidak valid</td></tr>`;
        return;
    }
    
    if (users.length === 0) {
        userTableBody.innerHTML = `<tr><td colspan="7" class="text-center">Tidak ada data petugas</td></tr>`;
        return;
    }
    
    users.forEach((user) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${user.username || '-'}</td>
            <td>${user.nama || user.username || '-'}</td>
            <td>
                <select class="form-select form-select-sm role-select" 
                        data-username="${user.username}"
                        data-original-role="${user.role}">
                    <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    <option value="kolektor" ${user.role === 'kolektor' ? 'selected' : ''}>Kolektor</option>
                </select>
            </td>
            <td>${user.jabatan || '-'}</td>
            <td>${user.desa || '-'}</td>
            <td>${user.kecamatan || '-'}</td>
            <td>
                <div class="reset-password-container" data-username="${user.username}">
                    <button class="btn btn-warning btn-sm btn-start-reset" title="Reset Password">
                        <i class="bi bi-key"></i>
                    </button>
                    <div class="reset-form d-none">
                        <input type="password" class="form-control form-control-sm reset-input" 
                               placeholder="Password baru" style="width: 100px;">
                        <button class="btn btn-success btn-sm btn-confirm-reset" title="Simpan">
                            <i class="bi bi-check"></i>
                        </button>
                        <button class="btn btn-secondary btn-sm btn-cancel-reset" title="Batal">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
                <button class="btn btn-danger btn-sm btnDelete" title="Hapus">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        // Event listener untuk dropdown role DENGAN NULL CHECK
        const roleSelect = tr.querySelector('.role-select');
        if (roleSelect) {
            roleSelect.addEventListener('change', function() {
                handleRoleChange(user.username, this.value);
            });
        }

        // Event untuk reset password DENGAN NULL CHECK
        const startBtn = tr.querySelector('.btn-start-reset');
        const resetForm = tr.querySelector('.reset-form');
        const resetInput = tr.querySelector('.reset-input');
        const confirmBtn = tr.querySelector('.btn-confirm-reset');
        const cancelBtn = tr.querySelector('.btn-cancel-reset');
        
        if (startBtn && resetForm && resetInput && confirmBtn && cancelBtn) {
            startBtn.addEventListener('click', function() {
                startBtn.classList.add('d-none');
                resetForm.classList.remove('d-none');
                resetInput.focus();
            });
            
            confirmBtn.addEventListener('click', function() {
                const newPassword = resetInput.value.trim();
                if (!newPassword) {
                    showToast('Password tidak boleh kosong', 'warning');
                    resetInput.focus();
                    return;
                }
                if (newPassword.length < 4) {
                    showToast('Password minimal 4 karakter', 'warning');
                    resetInput.focus();
                    return;
                }
                
                resetPassword(user.username, newPassword);
                resetInput.value = '';
                resetForm.classList.add('d-none');
                startBtn.classList.remove('d-none');
            });
            
            cancelBtn.addEventListener('click', function() {
                resetInput.value = '';
                resetForm.classList.add('d-none');
                startBtn.classList.remove('d-none');
            });
            
            resetInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmBtn.click();
                }
            });
        } else {
            console.warn('Reset password elements not found for user:', user.username);
        }

        // Event untuk delete user DENGAN NULL CHECK
        const deleteBtn = tr.querySelector(".btnDelete");
        if (deleteBtn) {
            deleteBtn.addEventListener("click", () => {
                if (confirm("Yakin hapus petugas " + (user.nama || user.username) + " (" + user.username + ")?")) {
                    deleteUser(user.username);
                }
            });
        }

        userTableBody.appendChild(tr);
    });
}

// Fungsi khusus untuk update role
function updateUserRole(username, newRole) {
    const currentUser = JSON.parse(localStorage.getItem('userData') || '{}');
    
    // Cegah user mengubah role sendiri
    if (username === currentUser.username) {
        showToast('Tidak dapat mengubah role sendiri', 'warning');
        
        // Reset dropdown
        const select = document.querySelector(`.role-select[data-username="${username}"]`);
        if (select) {
            select.value = currentUser.role || 'kolektor';
        }
        return;
    }
    if (!username || !newRole) {
        showToast('Data tidak lengkap', 'warning');
        return;
    }
    
    // Konfirmasi sebelum update
    if (!confirm(`Yakin ubah role ${username} menjadi ${newRole}?`)) {
        // Reset ke nilai semula jika dibatalkan
        const select = document.querySelector(`.role-select[data-username="${username}"]`);
        if (select) {
            const originalRole = select.querySelector('option[selected]')?.value || 'kolektor';
            select.value = originalRole;
        }
        return;
    }
    
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    
    const fd = new URLSearchParams();
    fd.append("action", "manageuser");
    fd.append("type", "update");
    fd.append("username", username);
    fd.append("role", newRole);
    fd.append("currentUser", userData.username || "admin");
    
    showLoading("Mengupdate role...");
    
    fetch(API_URL, { method: "POST", body: fd })
        .then((res) => res.json())
        .then((res) => {
            hideLoading();
            if (res.status === 'success') {
                showToast(`Role ${username} berhasil diubah menjadi ${newRole}`, 'success');
                // Optional: reload data untuk memastikan konsistensi
                // loadUsers();
            } else {
                showToast('Gagal update role: ' + res.message, 'danger');
                // Reset select jika gagal
                const select = document.querySelector(`.role-select[data-username="${username}"]`);
                if (select) {
                    const originalRole = select.querySelector('option[selected]')?.value || 'kolektor';
                    select.value = originalRole;
                }
            }
        })
        .catch((err) => {
            hideLoading();
            console.error("Error updating role:", err);
            showToast("Error update role: " + err.message, "danger");
            // Reset select jika error
            const select = document.querySelector(`.role-select[data-username="${username}"]`);
            if (select) {
                const originalRole = select.querySelector('option[selected]')?.value || 'kolektor';
                select.value = originalRole;
            }
        });
}

// Fungsi add user
function addUser(username, namaLengkap, password, role, jabatan = '', desa = '', kecamatan = '') {
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    
    const fd = new URLSearchParams();
    fd.append("action", "manageuser");
    fd.append("type", "add");
    fd.append("username", username);
    fd.append("nama", namaLengkap);
    fd.append("password", password);
    fd.append("role", role);
    fd.append("jabatan", jabatan);
    fd.append("desa", desa);
    fd.append("kecamatan", kecamatan);
    fd.append("currentUser", userData.username || "admin");
    
    showLoading("Menambah petugas...");
    
    fetch(API_URL, { method: "POST", body: fd })
        .then((res) => res.json())
        .then((res) => {
            hideLoading();
            if (res.status === 'success') {
                showToast('Petugas berhasil ditambahkan', 'success');
                loadUsers();
            } else {
                showToast('Gagal menambah petugas: ' + res.message, 'danger');
            }
        })
        .catch((err) => {
            hideLoading();
            console.error("Error adding user:", err);
            showToast("Error menambah petugas: " + err.message, "danger");
        });
}

// Fungsi reset password
function resetPassword(username, password) {
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    
    const fd = new URLSearchParams();
    fd.append("action", "manageuser");
    fd.append("type", "reset");
    fd.append("username", username);
    fd.append("password", password);
    fd.append("currentUser", userData.username || "admin");
    
    fetch(API_URL, { method: "POST", body: fd })
        .then((res) => res.json())
        .then((res) => {
            showToast(res.message, res.status === "success" ? "success" : "danger");
        })
        .catch((err) => {
            console.error("Error resetting password:", err);
            showToast("Error reset password: " + err.message, "danger");
        });
}

// Fungsi delete user
function deleteUser(username) {
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    
    const fd = new URLSearchParams();
    fd.append("action", "manageuser");
    fd.append("type", "delete");
    fd.append("username", username);
    fd.append("currentUser", userData.username || "admin");
    
    if (!confirm(`Yakin ingin menghapus petugas ${username}?`)) {
        return;
    }
    
    fetch(API_URL, { method: "POST", body: fd })
        .then((res) => res.json())
        .then((res) => {
            showToast(res.message, res.status === "success" ? "success" : "danger");
            if (res.status === "success") {
                loadUsers();
            }
        })
        .catch((err) => {
            console.error("Error deleting user:", err);
            showToast("Error delete user: " + err.message, "danger");
        });
}
// Inisialisasi tooltip Bootstrap
function initTooltips() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

// Panggil di DOMContentLoaded
document.addEventListener("DOMContentLoaded", function() {
    initTooltips();
});

// Helper function untuk safe event listener
function safeAddEventListener(element, event, callback) {
    if (element && typeof callback === 'function') {
        element.addEventListener(event, callback);
        return true;
    }
    console.warn('Cannot add event listener:', { element, event });
    return false;
}

// Perbaiki fungsi handleRoleChange dengan null checking
function handleRoleChange(username, newRole) {
    const currentUser = JSON.parse(localStorage.getItem('userData') || '{}');
    
    if (username === currentUser.username) {
        showToast('Tidak dapat mengubah role sendiri', 'warning');
        
        const select = document.querySelector(`.role-select[data-username="${username}"]`);
        if (select) {
            const originalRole = select.getAttribute('data-original-role');
            select.value = originalRole;
        }
        return;
    }
    
    if (confirm(`Yakin ubah role ${username} menjadi ${newRole}?`)) {
        updateUser(username, newRole);
    } else {
        const select = document.querySelector(`.role-select[data-username="${username}"]`);
        if (select) {
            const originalRole = select.getAttribute('data-original-role');
            select.value = originalRole;
        }
    }
}

// Alternatif dengan event delegation (lebih aman)
function setupEventDelegation() {
    const userTableBody = document.getElementById('userTableBody');
    if (!userTableBody) return;
    
    // Event delegation untuk role select
    userTableBody.addEventListener('change', function(e) {
        if (e.target.classList.contains('role-select')) {
            const username = e.target.getAttribute('data-username');
            const newRole = e.target.value;
            handleRoleChange(username, newRole);
        }
    });
    
    // Event delegation untuk tombol reset
    userTableBody.addEventListener('click', function(e) {
        const target = e.target;
        const row = target.closest('tr');
        
        if (!row) return;
        
        const username = row.querySelector('td:first-child').textContent;
        
        // Tombol start reset
        if (target.classList.contains('btn-start-reset') || target.closest('.btn-start-reset')) {
            const startBtn = row.querySelector('.btn-start-reset');
            const resetForm = row.querySelector('.reset-form');
            if (startBtn && resetForm) {
                startBtn.classList.add('d-none');
                resetForm.classList.remove('d-none');
                row.querySelector('.reset-input')?.focus();
            }
        }
        
        // Tombol confirm reset
        if (target.classList.contains('btn-confirm-reset') || target.closest('.btn-confirm-reset')) {
            const resetInput = row.querySelector('.reset-input');
            const startBtn = row.querySelector('.btn-start-reset');
            const resetForm = row.querySelector('.reset-form');
            
            if (resetInput && startBtn && resetForm) {
                const newPassword = resetInput.value.trim();
                if (newPassword && newPassword.length >= 4) {
                    resetPassword(username, newPassword);
                    resetInput.value = '';
                    resetForm.classList.add('d-none');
                    startBtn.classList.remove('d-none');
                }
            }
        }
        
        // Tombol cancel reset
        if (target.classList.contains('btn-cancel-reset') || target.closest('.btn-cancel-reset')) {
            const resetInput = row.querySelector('.reset-input');
            const startBtn = row.querySelector('.btn-start-reset');
            const resetForm = row.querySelector('.reset-form');
            
            if (resetInput && startBtn && resetForm) {
                resetInput.value = '';
                resetForm.classList.add('d-none');
                startBtn.classList.remove('d-none');
            }
        }
        
        // Tombol delete
        if (target.classList.contains('btnDelete') || target.closest('.btnDelete')) {
            if (confirm(`Yakin hapus petugas ${username}?`)) {
                deleteUser(username);
            }
        }
    });
}

// Panggil di DOMContentLoaded
document.addEventListener("DOMContentLoaded", function() {
    setupEventDelegation();
});


// Fungsi untuk menyiapkan data print RW RT
function prepareRWRTPrintData() {
    const rekapData = processRekapRWRT(allData);
    
    // Update informasi print
    const now = new Date();
    document.getElementById("printRWRTDate").textContent = `Tanggal: ${now.toLocaleDateString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    })}`;
    
    document.getElementById("printRWRTPeriod").textContent = `Periode: ${new Date().getFullYear()}`;
    document.getElementById("printRWRTTimestamp").textContent = now.toLocaleString('id-ID');
    
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    document.getElementById("printRWRTUser").textContent = userData.nama || userData.username || 'System';
    
    // Isi tabel
    const tableBody = document.getElementById("printRWRTTableBody");
    tableBody.innerHTML = '';
    
    let totalWP = 0;
    let totalPBB = 0;
    let totalRealisasi = 0;
    let totalSisa = 0;
    
    rekapData.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.className = item.type === 'rw' ? 'rw-row' : 'rt-row';
        
        tr.innerHTML = `
            <td>${item.alamat}</td>
            <td>${item.jumlahWP.toLocaleString('id-ID')}</td>
            <td>${item.totalPBB.toLocaleString('id-ID')}</td>
            <td>${item.realisasi.toLocaleString('id-ID')}</td>
            <td>${item.persenRealisasi}%</td>
            <td>${item.sisa.toLocaleString('id-ID')}</td>
            <td>${item.persenSisa}%</td>
        `;
        
        tableBody.appendChild(tr);
        
        // Hitung total
        if (item.type === 'rw') {
            totalWP += item.jumlahWP;
            totalPBB += item.totalPBB;
            totalRealisasi += item.realisasi;
            totalSisa += item.sisa;
        }
    });
    
    // Tambahkan baris total
    const totalPersenRealisasi = totalPBB > 0 ? Math.round((totalRealisasi / totalPBB) * 100) : 0;
    const totalPersenSisa = totalPBB > 0 ? Math.round((totalSisa / totalPBB) * 100) : 0;
    
    const footer = document.getElementById("printRWRTTableFooter");
    footer.innerHTML = `
        <tr class="total-row">
            <td style="text-align: "center;>TOTAL</td>
            <td style="text-align: "center;>${totalWP.toLocaleString('id-ID')}</td>
            <td style="text-align: "center;>${totalPBB.toLocaleString('id-ID')}</td>
            <td style="text-align: "center;>${totalRealisasi.toLocaleString('id-ID')}</td>
            <td style="text-align: "center;>${totalPersenRealisasi}%</td>
            <td style="text-align: "center;>${totalSisa.toLocaleString('id-ID')}</td>
            <td style="text-align: "center;>${totalPersenSisa}%</td>
        </tr>
    `;

}

// Fungsi untuk cetak PDF RW RT
function printRWRTPDF() {
    // Siapkan data untuk print
    prepareRWRTPrintData();
    
    // Tampilkan area print
    const printArea = document.getElementById("printRWRTArea");
    printArea.style.display = "block";
    
    // Tunggu sebentar agar render selesai
    setTimeout(() => {
        window.print();
        
        // Sembunyikan lagi setelah print
        setTimeout(() => {
            printArea.style.display = "none";
        }, 500);
    }, 500);
}

// Event listener untuk tombol print
document.addEventListener("DOMContentLoaded", function() {
    const btnPrintRWRTPDF = document.getElementById('btnPrintRWRTPDF');
    if (btnPrintRWRTPDF) {
        btnPrintRWRTPDF.addEventListener('click', printRWRTPDF);
    }
});



/**
 * Cek apakah user adalah admin dan tampilkan tombol sinkron
 */
function checkUserRoleAndShowSyncButton() {
  // Dapatkan data user dari localStorage/sessionStorage
  const userData = getUserData();
  
  if (userData && userData.role === 'admin') {
    // Tampilkan tombol sinkron untuk admin
    showSyncButton();
  } else {
    // Sembunyikan tombol sinkron untuk non-admin
    hideSyncButton();
  }
}

/**
 * Dapatkan data user
 */
function getUserData() {
  try {
    const userData = localStorage.getItem('userData') || sessionStorage.getItem('userData');
    if (userData) {
      return JSON.parse(userData);
    }
  } catch (e) {
    console.error('Error parsing user data:', e);
  }
  return null;
}

/**
 * Tampilkan tombol sinkron
 */
function showSyncButton() {
  const syncBtn = document.getElementById('syncAllDataBtn');
  if (syncBtn) {
    syncBtn.style.display = 'inline-block'; // atau ''
    syncBtn.disabled = false;
    // Cek apakah ada data untuk disinkron
    checkSyncDataAndUpdateButton();
  }
}

/**
 * Sembunyikan tombol sinkron
 */
function hideSyncButton() {
  const syncBtn = document.getElementById('syncAllDataBtn');
  if (syncBtn) {
    syncBtn.style.display = 'none';
  }
}

/**
 * Cek apakah ada data untuk disinkron dan update tombol
 */
function checkSyncDataAndUpdateButton() {
  const syncBtn = document.getElementById('syncAllDataBtn');
  if (!syncBtn) {
    console.log('Tombol syncAllDataBtn tidak ditemukan');
    return;
  }
  
  const userData = JSON.parse(localStorage.getItem('userData') || '{}');
  
  // Tampilkan loading di tombol
  const originalHTML = syncBtn.innerHTML;
  syncBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner"></i> Mengecek...';
  syncBtn.disabled = true;
  
  const formData = new URLSearchParams();
  formData.append('action', 'getsyncsummary');
  formData.append('username', userData.username || '');
  formData.append('nama_lengkap', userData.nama_lengkap || '');
  formData.append('role', userData.role || '');
  formData.append('desa', userData.desa || '');
  formData.append('kecamatan', userData.kecamatan || '');
  
  fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: formData
  })
  .then(response => {
    if (!response.ok) throw new Error('Network response was not ok');
    return response.json();
  })
  .then(data => {
    if (data.status === 'success' && data.summary && data.summary.totalWP > 0) {
      // Ada data - tombol aktif
      syncBtn.innerHTML = '<i class="bi bi-speedometer2"></i> Sinkron Semua Data';
      syncBtn.disabled = false;
      syncBtn.title = `Ada ${data.summary.totalWP} data (Rp ${data.summary.totalPBB?.toLocaleString('id-ID') || 0}) yang perlu disinkron`;
      syncBtn.classList.remove('btn-secondary');
      syncBtn.classList.add('btn-warning');
    } else {
      // Tidak ada data - tombol disabled
      syncBtn.innerHTML = '<i class="bi bi-check-circle"></i> Data Sudah Sync';
      syncBtn.disabled = true;
      syncBtn.title = 'Semua data sudah tersinkronisasi';
      syncBtn.classList.remove('btn-warning');
      syncBtn.classList.add('btn-secondary');
    }
  })
  .catch(error => {
    console.error('Error checking sync data:', error);
    // Jika error, tetap aktifkan tombol sebagai fallback
    syncBtn.innerHTML = '<i class="bi bi-speedometer2"></i> Sinkron Semua Data';
    syncBtn.disabled = false;
    syncBtn.title = 'Klik untuk sinkronisasi data';
    syncBtn.classList.remove('btn-secondary');
    syncBtn.classList.add('btn-warning');
  });
}

/**
 * Jalankan pengecekan saat halaman dimuat
 */
document.addEventListener('DOMContentLoaded', function() {
  // Cek role user dan tampilkan/sembunyikan tombol
  checkUserRoleAndShowSyncButton();
});

document.addEventListener('click', function(e) {
  const syncBtn = e.target.closest('#syncAllDataBtn') || e.target.closest('.btn-sync-global');
  if (syncBtn) {
    checkSyncDataAndUpdateButton();
  }
})

// Tampilkan tombol sinkron HANYA jika role = admin  DAN hanya setelah data login dimuat
function setupSyncButtonVisibility() {
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    const syncContainer = document.getElementById('syncButtonContainer');
    
    if (syncContainer && userData.role === 'admin') {
        syncContainer.style.display = 'inline-block';
    } else {
        syncContainer.style.display = 'none';
    }
}

// Jalankan saat DOM siap
document.addEventListener('DOMContentLoaded', setupSyncButtonVisibility);

// Jalankan juga setelah login berhasil
window.addEventListener('loginSuccess', setupSyncButtonVisibility); // <-- Anda bisa trigger event ini di handleLogin()

/**
 * Fungsi untuk memicu sinkronisasi global
 */
async function syncAllData() {
    const syncBtn = document.getElementById('syncAllDataBtn');
    if (!syncBtn) {
        console.error('Tombol syncAllDataBtn tidak ditemukan!');
        return;
    }

    // Tampilkan loading
    const originalHTML = syncBtn.innerHTML;
    syncBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner"></i> Sedang menyinkron...';
    syncBtn.disabled = true;

    try {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const formData = new URLSearchParams();
        formData.append('action', 'syncalldata');
        formData.append('username', userData.username || '');

        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData
        });

        const result = await response.json();

        if (result.status === 'success') {
            showToast(`Berhasil menyinkron ${result.syncedCount} data`, 'success');
            // Refresh data setelah sinkron
            refreshData();
        } else {
            showToast('Gagal menyinkron: ' + result.message, 'danger');
        }
    } catch (error) {
        console.error('Error syncing data:', error);
        showToast('Terjadi kesalahan jaringan saat menyinkron.', 'danger');
    } finally {
        // Kembalikan tombol ke semula
        syncBtn.innerHTML = originalHTML;
        syncBtn.disabled = false;
    }
}

// Daftar pemilik yang sudah diproses (di-cache saat data dimuat)
let girikPemilikList = [];

// Fungsi untuk memproses daftar pemilik dari data PBB
function populateGirikPemilikList() {
    if (!allData || allData.length === 0) {
        girikPemilikList = [];
        return;
    }

    const pemilikMap = new Map();
    allData.forEach(row => {
        const pemilik = row[indexMap['Pemilik']] || 'Tidak Diketahui';
        const alamatPemilik = row[indexMap['Alamat_Pemilik']] || 'Alamat tidak tersedia';

        const key = `${pemilik} | ${alamatPemilik}`;
        if (!pemilikMap.has(key)) {
            pemilikMap.set(key, { pemilik, alamatPemilik });
        }
    });

    // Urutkan berdasarkan nama pemilik
    girikPemilikList = Array.from(pemilikMap.values()).sort((a, b) =>
        a.pemilik.localeCompare(b.pemilik)
    );
}

// Fungsi untuk menampilkan saran pencarian
function showGirikSuggestions() {
    const input = document.getElementById('girikSearchInput');
    const suggestionsContainer = document.getElementById('girikSuggestions');
    const infoAlert = document.getElementById('girikInfoAlert');

    const query = input.value.trim().toLowerCase();
    if (query.length < 1) {
        suggestionsContainer.style.display = 'none';
        infoAlert.classList.remove('d-none');
        renderGirikTable([]); // Tampilkan semua data atau kosong
        return;
    }

    infoAlert.classList.add('d-none');

    // Filter data pemilik berdasarkan input
    const filtered = girikPemilikList.filter(item =>
        item.pemilik.toLowerCase().includes(query) ||
        item.alamatPemilik.toLowerCase().includes(query)
    );

    if (filtered.length === 0) {
        suggestionsContainer.innerHTML = `
            <div class="list-group-item text-center py-3 text-muted">
                Tidak ditemukan pemilik dengan "${query}"
            </div>
        `;
        suggestionsContainer.style.display = 'block';
        renderGirikTable([]); // Tampilkan data kosong
        return;
    }

    // Isi kontainer dengan saran
    suggestionsContainer.innerHTML = '';
    filtered.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'girik-suggestion-item';
        itemEl.innerHTML = `
            <strong>${item.pemilik}</strong>
            <small>${item.alamatPemilik}</small>
        `;
        itemEl.addEventListener('click', () => {
            input.value = item.pemilik;
            selectGirikPemilik(item.pemilik, item.alamatPemilik);
            suggestionsContainer.style.display = 'none';
        });
        suggestionsContainer.appendChild(itemEl);
    });

    suggestionsContainer.style.display = 'block';
    renderGirikTable([]); // Tunggu sampai user pilih, belum filter data
}

// Fungsi untuk memilih pemilik dari saran
function selectGirikPemilik(nama, alamat) {
    const filteredData = allData.filter(row => {
        const pemilik = row[indexMap['Pemilik']] || '';
        return pemilik.trim().toLowerCase() === nama.trim().toLowerCase();
    });

    renderGirikTable(filteredData);
    document.getElementById('girikInfoAlert').classList.add('d-none');
    document.getElementById('girikSearchInput').blur(); // Hilangkan fokus input
}

// Fungsi untuk merender tabel Girik Tagihan
function renderGirikTable(data) {
    const tableBody = document.getElementById('girikTableBody');
    const totalPBBElement = document.getElementById('girikTotalPBB');

    if (!data || data.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4">
                    <i class="bi bi-inbox display-5 d-block text-muted mb-2"></i>
                    <span class="text-muted">Tidak ada data PBB untuk pemilik terpilih</span>
                </td>
            </tr>
        `;
        totalPBBElement.textContent = 'Rp 0';
        return;
    }

    tableBody.innerHTML = '';
    let totalPBB = 0;

    data.forEach((row, idx) => {
        const nop = row[indexMap['NOP']] || '-';
        const tahun = row[indexMap['Tahun']] || '-';
        const namaWP = row[indexMap['Nama_WP']] || '-';
        const alamatWP = row[indexMap['Alamat_WP']] || '-';
        const alamatOP = row[indexMap['Alamat_Objek']] || '-';
        const pokokPBB = parseFloat(row[indexMap['Pokok_PBB']] || 0);
        const tanggalBayar = formatTanggalIndonesia(row[indexMap['Tanggal_Bayar']]);
        const kolektor = row[indexMap['Kolektor']] || '-';

        totalPBB += pokokPBB;

        const rowHtml = `
            <tr>
                <td style="text-align: center;">${idx + 1}</td>
                <td style="text-align: center;">${nop}</td>
                <td style="text-align: left;">${namaWP}</td>
                <td style="text-align: left;">${alamatWP}</td>
                <td style="text-align: left;">${alamatOP}</td>
                <td style="text-align: right;">${Number(pokokPBB).toLocaleString("id-ID")}</td>
                <td style="text-align: center;">${tanggalBayar}</td>
                <td style="text-align: left;">${kolektor}</td>
            </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', rowHtml);
    });

    totalPBBElement.textContent = toRupiah(totalPBB);
}

// Fungsi untuk mencetak Girik Tagihan ke PDF
function cetakGirikTagihan() {
    // Siapkan data cetak
    preparePrintGirikData();

    // Tampilkan area print
    const printArea = document.getElementById("printGirikArea");
    printArea.style.display = "block";

    // Tunggu render, lalu cetak
    setTimeout(() => {
        window.print();
        printArea.style.display = "none";
    }, 500);
}

// Siapkan data untuk dicetak (mirip dengan versi lama, tapi disesuaikan)
function preparePrintGirikData() {
    const now = new Date();
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    const dateStr = now.toLocaleDateString('id-ID', options);

    // Update info
    document.getElementById("printDate").textContent = `Tanggal: ${dateStr}`;
    document.getElementById("printTimestamp").textContent = now.toLocaleString('id-ID');

    // Ambil data dari tabel yang sedang ditampilkan
    const tableBody = document.getElementById('girikTableBody');
    const rows = tableBody.querySelectorAll('tr:not(.total-row)');
    const filteredData = [];

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 8) {
            filteredData.push({
                nop: cells[1].textContent,
                namaWP: cells[2].textContent,
                alamatWP: cells[3].textContent,
                alamatOP: cells[4].textContent,
                pokokPBB: parseFloat(cells[5].textContent.replace(/[^\d]/g, '')),
                tanggalBayar: cells[6].textContent,
                kolektor: cells[7].textContent
            });
        }
    });

    // Isi tabel cetak
    const printTableBody = document.getElementById("printGirikTableBody");
    printTableBody.innerHTML = '';

    filteredData.forEach((item, idx) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="text-align: center;">${idx + 1}</td>
            <td style="text-align: center;">${item.nop}</td>
            <td style="text-align: left;">${item.namaWP}</td>
            <td style="text-align: left;">${item.alamatWP}</td>
            <td style="text-align: left;">${item.alamatOP}</td>
            <td style="text-align: right;">${Number(item.pokokPBB).toLocaleString("id-ID")}</td>
            <td style="text-align: center;">${item.tanggalBayar}</td>
            <td style="text-align: left;">${item.kolektor}</td>
        `;
        printTableBody.appendChild(row);
    });

    // Hitung total
    const totalPBB = filteredData.reduce((sum, item) => sum + item.pokokPBB, 0);
    document.getElementById("printTotalPBB").textContent = toRupiah(totalPBB);
}

// Fungsi navigasi ke halaman Girik Tagihan
function navigateToGirikSection() {
    // Sembunyikan semua section
    const allSections = [
        'dashboardStats', 'collectorCardsContainer', 'gridCardSection',
        'sinkReportSection', 'rekapRWRTSection', 'rekapKolektorSection'
    ];
    allSections.forEach(sectionId => {
        const element = document.getElementById(sectionId);
        if (element) element.style.display = 'none';
    });

    // Tampilkan section Girik
    document.getElementById('girikSection').style.display = 'block';

    // Load data jika belum
    if (allData.length === 0) {
        refreshData();
    } else {
        populateGirikPemilikList();
        renderGirikTable([]);
    }
}

// Event listener untuk tombol Cetak PDF
document.getElementById('btnPrintGirikPDF')?.addEventListener('click', cetakGirikTagihan);

// Event listener untuk input pencarian
document.getElementById('girikSearchInput')?.addEventListener('input', showGirikSuggestions);

// Event listener untuk tombol refresh
document.getElementById('btnRefreshGirik')?.addEventListener('click', () => {
    document.getElementById('girikSearchInput').value = '';
    document.getElementById('girikSuggestions').style.display = 'none';
    renderGirikTable([]);
});

// Event listener untuk klik di luar saran
document.addEventListener('click', (e) => {
    const searchInput = document.getElementById('girikSearchInput');
    const suggestions = document.getElementById('girikSuggestions');
    if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
        suggestions.style.display = 'none';
    }
});

// Event listener untuk Enter pada input
document.getElementById('girikSearchInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        const value = e.target.value.trim();
        if (value) {
            const match = girikPemilikList.find(item => 
                item.pemilik.toLowerCase().includes(value.toLowerCase())
            );
            if (match) {
                selectGirikPemilik(match.pemilik, match.alamatPemilik);
            }
        }
    }
});
</script>
</body>
</html>
